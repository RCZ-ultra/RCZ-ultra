<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>RÃ©vision des verbes anglais</title>

<style>
body {
  font-family: Arial, sans-serif;
  background:#f4f4f4;
  padding:20px;
}
.card {
  background:#fff;
  padding:20px;
  max-width:600px;
  margin:auto;
  border-radius:10px;
  box-shadow:0 2px 8px rgba(0,0,0,.1);
}
h1 { text-align:center; }
label { display:block; margin-top:10px; }
input { width:100%; padding:8px; margin-top:4px; }
button { margin-top:15px; padding:10px; width:100%; font-size:16px; }
.hidden { display:none; }
.result { margin-top:15px; }

table td, table th {
  border: 1px solid #ccc;
  padding: 6px;
  font-size: 14px;
}

table tr:nth-child(even) {
  background: #fafafa;
}

.verbe-maitrise {
  background: #d4edda;
  color: #155724;
}

.verbe-probleme {
  background: #f8d7da;
  color: #721c24;
}

.verbe-neutre {
  background: #ffffff;
}

.verbe-maitrise td,
.verbe-probleme td,
.verbe-neutre td {
  border: 1px solid #ccc;
  padding: 6px;
}

@keyframes successFlash {
  0%   { background-color: #ffffff; }
  30%  { background-color: #d4edda; }
  100% { background-color: #ffffff; }
}

@keyframes successPop {
  0%   { transform: scale(1); }
  40%  { transform: scale(1.05); }
  100% { transform: scale(1); }
}

.success-animation {
  animation: successFlash 0.6s ease, successPop 0.4s ease;
}

</style>
</head>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script> <!-- La librairie jspdf est utilisÃ© pour gÃ©nÃ©rer le PDF des statistiques -->

<body>

<div class="card">
<h1>ğŸ“˜ Verbes irrÃ©guliers anglais</h1>

<div id="menu">
<!--  <button onclick="start('random')">ğŸ² Apprentissage alÃ©atoire</button> -->
  <button onclick="start('cible')">ğŸ¯ RÃ©vision ciblÃ©e</button>
  <button onclick="ouvrirVerbesPerso()">ğŸ§© Verbes personnalisÃ©s</button>
  <button onclick="afficherStats()">ğŸ“Š Statistiques</button>
<button id="btnActiverNotif" onclick="activerNotifications()">ğŸ”” Activer les notifications</button>
<button id="btnDesactiverNotif" onclick="desactiverNotifications()" class="hidden">ğŸ”• DÃ©sactiver les notifications</button>
<p style="text-align:center; margin-top:10px;">
  ğŸ”¥ SÃ©rie actuelle : <strong id="streakMenu">0</strong> jour(s)
</p>

</div>

<audio id="youpiAudio" src="youpi.mp3"></audio>
<audio id="eOhAudio" src="e_oh.mp3"></audio>

<div id="quiz" class="hidden">

  <p><strong>Infinitif :</strong> <span id="inf"></span></p>
  <p><strong>Sens :</strong> <span id="sens"></span></p>

  <label id="extraLabel" class="hidden">
    Ta rÃ©ponse
    <input id="extraInput" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  </label>

  <label id="presLabel">PrÃ©sent
    <input id="pres" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  </label>

  <label id="pretLabel">PrÃ©tÃ©rit
    <input id="pret" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  </label>

  <label id="parfLabel">Parfait
    <input id="parf" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  </label>

  <button onclick="check()">Valider</button>

  <div class="result" id="result"></div>
  <p id="messageEncouragement" class="hidden">RÃ©essaye encore ğŸ’ª</p>
  <button onclick="next()" id="nextBtn" class="hidden">â¡ï¸ Verbe suivant</button>

</div>

<div id="verbesPerso" class="hidden">
  <h2>ğŸ“‚ Mes listes de verbes</h2>

  <label>Nouvelle liste
    <input id="nomListe">
  </label>
  <button onclick="creerListe()">â• CrÃ©er la liste</button>

  <div id="listesExistantes"></div>

  <hr>

  <div id="gestionListe" class="hidden">
    <h3 id="titreListe"></h3>

    <label>Infinitif <input id="p_inf"></label>
    <label>PrÃ©sent <input id="p_pres"></label>
    <label>PrÃ©tÃ©rit <input id="p_pret"></label>
    <label>Parfait <input id="p_parf"></label>
    <label>Sens ( ; pour sÃ©parer) <input id="p_sens"></label>

    <button onclick="ajouterVerbePerso()">ğŸ’¾ Ajouter le verbe</button>
    <button onclick="reviserListePerso()">ğŸ¯ RÃ©viser cette liste</button>
    <button onclick="exporterListe()">ğŸ“¤ Exporter la liste</button>

<label style="margin-top:10px;">
  ğŸ“¥ Importer une liste
  <input type="file" id="importListeInput" accept=".json" onchange="importerListe(event)">
</label>


    <div id="listeVerbesPerso"></div>
  </div>
</div>



<div id="statsPanel" class="hidden">
  <h2>ğŸ“Š Statistiques</h2>
  <div id="statsContent"></div>
  <div id="listeCompleteVerbes" class="hidden"></div>
  <p>
  Notifications :
  <strong id="etatNotif"></strong>
</p>
<button onclick="exporterDonnees()">ğŸ’¾ Exporter mes progrÃ¨s et statistiques</button>
<button onclick="importerDonnees()">ğŸ“‚ Importer mes progrÃ¨s et statistiques</button>
<button onclick="exporterPDF()">ğŸ“„ GÃ©nÃ©rer un PDF de mes statistiques</button>
<button onclick="afficherTousLesVerbes()">ğŸ“‹ Voir tous les verbes</button>

<input type="file" id="importFile" accept=".json" class="hidden">

  <button onclick="fermerStats()">â¬… Retour</button>
</div>
</div>

<script>
// ================== PARAMÃˆTRES ==================
const TAILLE_PALIER = 5;
const SEUIL_MAITRISE = 3;
const TAUX_REVISION = 0.2;
const QUESTION_TYPES = ["classique", "sens_inf", "inf_sens"];

// ================== VERBES ==================
const verbes = [
  { inf: "be", pres: "be", pret: "was/were", parf: "been", sens: "Ãªtre" },
  { inf: "become", pres: "become", pret: "became", parf: "become", sens: "devenir" },
  { inf: "begin", pres: "begin", pret: "began", parf: "begun", sens: "commencer" },
  { inf: "break", pres: "break", pret: "broke", parf: "broken", sens: "casser" },
  { inf: "bring", pres: "bring", pret: "brought", parf: "brought", sens: "apporter" },
  { inf: "build", pres: "build", pret: "built", parf: "built", sens: "construire" },
  { inf: "buy", pres: "buy", pret: "bought", parf: "bought", sens: "acheter" },
  { inf: "catch", pres: "catch", pret: "caught", parf: "caught", sens: "attraper" },
  { inf: "choose", pres: "choose", pret: "chose", parf: "chosen", sens: "choisir" },
  { inf: "come", pres: "come", pret: "came", parf: "come", sens: "venir" },

  { inf: "cost", pres: "cost", pret: "cost", parf: "cost", sens: "coÃ»ter" },
  { inf: "cut", pres: "cut", pret: "cut", parf: "cut", sens: "couper" },
  { inf: "do", pres: "do", pret: "did", parf: "done", sens: "faire" },
  { inf: "draw", pres: "draw", pret: "drew", parf: "drawn", sens: "dessiner" },
  { inf: "drink", pres: "drink", pret: "drank", parf: "drunk", sens: "boire" },
  { inf: "drive", pres: "drive", pret: "drove", parf: "driven", sens: "conduire" },
  { inf: "eat", pres: "eat", pret: "ate", parf: "eaten", sens: "manger" },
  { inf: "fall", pres: "fall", pret: "fell", parf: "fallen", sens: "tomber" },
  { inf: "feel", pres: "feel", pret: "felt", parf: "felt", sens: "ressentir" },
  { inf: "find", pres: "find", pret: "found", parf: "found", sens: "trouver" },

  { inf: "fly", pres: "fly", pret: "flew", parf: "flown", sens: "voler" },
  { inf: "forget", pres: "forget", pret: "forgot", parf: "forgotten", sens: "oublier" },
  { inf: "forgive", pres: "forgive", pret: "forgave", parf: "forgiven", sens: "pardonner" },
  { inf: "get", pres: "get", pret: "got", parf: "got/gotten", sens: "obtenir" },
  { inf: "give", pres: "give", pret: "gave", parf: "given", sens: "donner" },
  { inf: "go", pres: "go", pret: "went", parf: "gone", sens: "aller" },
  { inf: "grow", pres: "grow", pret: "grew", parf: "grown", sens: "grandir" },
  { inf: "have", pres: "have", pret: "had", parf: "had", sens: "avoir" },
  { inf: "hear", pres: "hear", pret: "heard", parf: "heard", sens: "entendre" },
  { inf: "hold", pres: "hold", pret: "held", parf: "held", sens: "tenir" },

  { inf: "keep", pres: "keep", pret: "kept", parf: "kept", sens: "garder" },
  { inf: "know", pres: "know", pret: "knew", parf: "known", sens: "savoir / connaÃ®tre" },
  { inf: "learn", pres: "learn", pret: "learnt/learned", parf: "learnt/learned", sens: "apprendre" },
  { inf: "leave", pres: "leave", pret: "left", parf: "left", sens: "partir / quitter" },
  { inf: "lend", pres: "lend", pret: "lent", parf: "lent", sens: "prÃªter" },
  { inf: "lose", pres: "lose", pret: "lost", parf: "lost", sens: "perdre" },
  { inf: "make", pres: "make", pret: "made", parf: "made", sens: "fabriquer" },
  { inf: "mean", pres: "mean", pret: "meant", parf: "meant", sens: "signifier" },
  { inf: "meet", pres: "meet", pret: "met", parf: "met", sens: "rencontrer" },
  { inf: "pay", pres: "pay", pret: "paid", parf: "paid", sens: "payer" },

  { inf: "put", pres: "put", pret: "put", parf: "put", sens: "mettre" },
  { inf: "read", pres: "read", pret: "read", parf: "read", sens: "lire" },
  { inf: "run", pres: "run", pret: "ran", parf: "run", sens: "courir" },
  { inf: "say", pres: "say", pret: "said", parf: "said", sens: "dire" },
  { inf: "see", pres: "see", pret: "saw", parf: "seen", sens: "voir" },
  { inf: "sell", pres: "sell", pret: "sold", parf: "sold", sens: "vendre" },
  { inf: "send", pres: "send", pret: "sent", parf: "sent", sens: "envoyer" },
  { inf: "sit", pres: "sit", pret: "sat", parf: "sat", sens: "s'asseoir" },
  { inf: "sleep", pres: "sleep", pret: "slept", parf: "slept", sens: "dormir" },
  { inf: "speak", pres: "speak", pret: "spoke", parf: "spoken", sens: "parler" },

  { inf: "stand", pres: "stand", pret: "stood", parf: "stood", sens: "se tenir debout" },
  { inf: "swim", pres: "swim", pret: "swam", parf: "swum", sens: "nager" },
  { inf: "take", pres: "take", pret: "took", parf: "taken", sens: "prendre" },
  { inf: "teach", pres: "teach", pret: "taught", parf: "taught", sens: "enseigner" },
  { inf: "tell", pres: "tell", pret: "told", parf: "told", sens: "raconter / dire" },
  { inf: "think", pres: "think", pret: "thought", parf: "thought", sens: "penser" },
  { inf: "throw", pres: "throw", pret: "threw", parf: "thrown", sens: "jeter" },
  { inf: "understand", pres: "understand", pret: "understood", parf: "understood", sens: "comprendre" },
  { inf: "wear", pres: "wear", pret: "wore", parf: "worn", sens: "porter (vÃªtement)" },
  { inf: "write", pres: "write", pret: "wrote", parf: "written", sens: "Ã©crire" }
];


// ============VERBES PERSONNALISÃ©S =================//

//listesPerso = {
//  "Ma liste 1": [ {inf, pres, ...}, ... ],
//  "Verbes difficiles": [ ... ],
//  "Cours anglais": [ ... ]
//}

function supprimerListe(nom) {
  if (!confirm(`Supprimer la liste "${nom}" ?`)) return;
  delete listesPerso[nom];
  localStorage.setItem("listesPerso", JSON.stringify(listesPerso));
  afficherListes();
}


let listesPerso =
  JSON.parse(localStorage.getItem("listesPerso")) || {};

let listePersoActive = null;

    let verbesPersonnalises =
        JSON.parse(localStorage.getItem("verbesPerso")) || [];

  let verbesDeBase = [...verbes];
  let verbesActifs = verbesDeBase;


function creerListe() {
  const nom = nomListe.value.trim();
  if (!nom || listesPerso[nom]) {
    alert("Nom invalide ou dÃ©jÃ  existant");
    return;
  }

  listesPerso[nom] = [];
  localStorage.setItem("listesPerso", JSON.stringify(listesPerso));
  nomListe.value = "";
  afficherListes();
}

function afficherListes() {
  const div = document.getElementById("listesExistantes");
  div.innerHTML = "<h3>ğŸ“š Listes existantes</h3>";

  Object.keys(listesPerso).forEach(nom => {
    const container = document.createElement("div");

    const span = document.createElement("span");
    span.textContent = nom;

    const btnEdit = document.createElement("button");
    btnEdit.textContent = "âœï¸";
    btnEdit.addEventListener("click", () => ouvrirListe(nom));

    const btnDelete = document.createElement("button");
    btnDelete.textContent = "âŒ";
    btnDelete.addEventListener("click", () => supprimerListe(nom));

    container.appendChild(span);
    container.appendChild(btnEdit);
    container.appendChild(btnDelete);

    div.appendChild(container);
  });
}


// =========== VERBES DÃ‰BLOQUÃ‰S ==============
function getVerbesDebloques(listeVerbes) {
  const TAILLE_GROUPE = 5;
  let groupesDebloques = 1; // le 1er est toujours dispo

  for (let i = 0; i < listeVerbes.length; i += TAILLE_GROUPE) {
    const groupe = listeVerbes.slice(i, i + TAILLE_GROUPE);

    const maitrisÃ©s = groupe.filter(v =>
      stats[v.inf] && stats[v.inf].maitrise >= 3 // les verbes suivants sont dÃ©bloquÃ©s quand tous les premiers verbes sont maÃ®trisÃ©s
    ).length;

    if (maitrisÃ©s >= 3) {
      groupesDebloques++;
      console.log("Groupes dÃ©bloquÃ©s");
    } else {
      break;
    }
  }

  return listeVerbes.slice(0, groupesDebloques * TAILLE_GROUPE);
}



// ================== NORMALISATION ==================
function normaliser(texte) {
  return texte.trim().toLowerCase();
}

// ================ ANIMATION QUAND ON RÃ‰USSI UN VERBE ==============

function animationBonneReponse() {
  const card = document.querySelector(".card");
  card.classList.remove("success-animation"); // reset
  void card.offsetWidth; // force reflow
  card.classList.add("success-animation");
}


// ================== SUCCÃˆS ====================
const SUCCES = [
  {
    id: "premier_verbe",
    titre: "PremiÃ¨re victoire ğŸ‰",
    description: "RÃ©viser ton premier verbe",
    condition: () => {
      return Object.values(stats).some(s => s.propositions >= 1);
    }
  },
  {
    id: "10_maitrises",
    titre: "Ã‡a rentre ! ğŸ’ª",
    description: "Atteindre 10 maÃ®trises",
    condition: () => {
      return Object.values(stats).reduce((s, v) => s + v.maitrise, 0) >= 10;
    }
  },
  {
    id: "streak_7",
    titre: "RÃ©gularitÃ© ğŸ”¥",
    description: "SÃ©rie de 7 jours consÃ©cutifs",
    condition: () => {
      const streak = JSON.parse(localStorage.getItem("streak")) || { count: 0 };
      return streak.count >= 7;
    }
  },
  {
    id: "sans_faute",
    titre: "Sans faute ğŸ§ ",
    description: "3 rÃ©ponses parfaites dâ€™affilÃ©e",
    condition: () => {
      return succesState.perfectStreak >= 3;
    }
  },
  {
  id: "verbe_maitrise",
  titre: "Sous contrÃ´le âœ…",
  description: "MaÃ®triser complÃ¨tement un verbe",
  condition: () => {
    return Object.values(stats).some(v => v.maitrise >= 5);
    }
  },
  {
  id: "revanche",
  titre: "Revanche ğŸ”",
  description: "Transformer un verbe problÃ©matique en verbe maÃ®trisÃ©",
  condition: () => {
      return Object.values(stats).some(v => v.erreurs >= 3 && v.maitrise >= 5);
    }
  },
{
  id: "50_propositions",
  titre: "Ã‡a travaille ğŸ“š",
  description: "RÃ©viser 50 verbes au total",
  condition: () => {
    return Object.values(stats)
      .reduce((s, v) => s + v.propositions, 0) >= 50;
  }
},
{
  id: "100_propositions",
  titre: "Machine Ã  verbes ğŸ¤–",
  description: "RÃ©viser 100 verbes au total",
  condition: () => {
    return Object.values(stats)
      .reduce((s, v) => s + v.propositions, 0) >= 100;
  }
},
{
  id: "verbes_problematiques",
  titre: "Face Ã  la difficultÃ© ğŸ§±",
  description: "RÃ©viser 10 fois des verbes problÃ©matiques",
  condition: () => {
    return sessionStats.problematiquesRevises >= 10;
  }
},
{
  id: "tout_vert",
  titre: "Tout au vert âœ…",
  description: "Avoir 5 verbes en zone maÃ®trisÃ©e",
  condition: () => {
    return Object.values(stats)
      .filter(v => v.maitrise >= 5 && v.erreurs === 0).length >= 5;
  }
},
{
  id: "createur_verbes",
  titre: "CrÃ©ateur ğŸ“–",
  description: "CrÃ©er 10 verbes personnalisÃ©s",
  condition: () => {
    return Object.keys(verbesPersonnalises || {}).length >= 10;
  }
},
{
  id: "exporteur",
  titre: "Sauvegarde ğŸ”",
  description: "Exporter ses statistiques ou ses verbes",
  condition: () => {
    return succesState.exportEffectue === true;
  }
},
{
  id: "importeur",
  titre: "Retour gagnant ğŸ”„",
  description: "Importer des statistiques ou une liste",
  condition: () => {
    return succesState.importEffectue === true;
  }
},
{
  id: "revision_planifiee",
  titre: "MÃ©moire longue ğŸ§ ",
  description: "ComplÃ©ter 5 rÃ©visions planifiÃ©es",
  condition: () => {
    return succesState.revisionsPlanifiees >= 5;
  }
},
{
  id: "streak_30",
  titre: "Habitude ancrÃ©e ğŸ”¥",
  description: "SÃ©rie de 30 jours consÃ©cutifs",
  condition: () => {
    const streak = JSON.parse(localStorage.getItem("streak")) || { count: 0 };
    return streak.count >= 30;
  }
},
{
  id: "perfectionniste",
  titre: "Perfectionniste âœ¨",
  description: "RÃ©pondre parfaitement Ã  10 verbes consÃ©cutifs",
  condition: () => {
    return succesState.perfectStreak >= 10;
  }
}

];

let succesState = JSON.parse(localStorage.getItem("succes")) || {
  debloques: [],
  perfectStreak: 0
};

function verifierSucces() {
  let nouveau = false;

  SUCCES.forEach(s => {
    if (!succesState.debloques.includes(s.id) && s.condition()) {
      succesState.debloques.push(s.id);
      afficherSucces(s);
      nouveau = true;
    }
  });

  if (nouveau) {
    localStorage.setItem("succes", JSON.stringify(succesState));
  }
}

function afficherSucces(succes) {
  const div = document.createElement("div");
  div.style.position = "fixed";
  div.style.bottom = "20px";
  div.style.right = "20px";
  div.style.background = "#ffd700";
  div.style.padding = "15px";
  div.style.borderRadius = "10px";
  div.style.boxShadow = "0 4px 10px rgba(0,0,0,.2)";
  div.style.zIndex = 9999;
  div.innerHTML = `
    <strong>ğŸ† SuccÃ¨s dÃ©bloquÃ© !</strong><br>
    ${succes.titre}<br>
    <small>${succes.description}</small>
  `;

  document.body.appendChild(div);

  setTimeout(() => div.remove(), 4000);
}


// ================== VARIABLES ==================
let mode = "random";
let current = null;
let questionType = "classique";

const youpiAudio = document.getElementById("youpiAudio");
const eOhAudio = document.getElementById("eOhAudio");

let stats = JSON.parse(localStorage.getItem("stats")) || {};
let streak = JSON.parse(localStorage.getItem("streak")) || {
  count: 0,
  lastDate: null
};

verbes.forEach(v => {
  if (!stats[v.inf]) stats[v.inf] = stats[inf] = {
  propositions: 0,
  erreurs: 0,
  maitrise: 0,
  nextReview: null,   // timestamp
  interval: 0         // index dâ€™intervalle
};
;
});

let cacheTousLesVerbes = [];

const TAILLE_GROUPE = 5;

function getGroupIndex(index) {
  return Math.floor(index / TAILLE_GROUPE);
}

function groupesDebloques() {
  let groupes = [];

  for (let i = 0; i < verbes.length; i += TAILLE_GROUPE) {
    const groupe = verbes.slice(i, i + TAILLE_GROUPE);

    const maitriseOK = groupe.every(v => stats[v.inf]?.maitrise >= 1);

    groupes.push({
      debut: i + 1,
      fin: Math.min(i + TAILLE_GROUPE, verbes.length),
      debloque: maitriseOK
    });

    if (!maitriseOK) break;
  }

  return groupes;
}

// =================Notifications ========

function verifierRevisions() {
  if (localStorage.getItem("notificationsActivees") !== "true") return;

  const today = new Date().toISOString().slice(0,10);
  const derniereNotif = localStorage.getItem("derniereNotification");

  if (derniereNotif === today) return;

  const aReviser = verbesEnAttenteDeRevision();

  if (aReviser.length > 0) {
    envoyerNotification(aReviser.length);
    localStorage.setItem("derniereNotification", today);
  }
}

function activerNotifications() {
  if (!("Notification" in window)) {
    alert("Les notifications ne sont pas supportÃ©es par ce navigateur.");
    return;
  }

  Notification.requestPermission().then(permission => {
    if (permission === "granted") {
      localStorage.setItem("notificationsActivees", "true");
      alert("ğŸ”” Notifications activÃ©es !");
      verifierRevisions(); // test immÃ©diat
    } else {
      alert("Notifications refusÃ©es.");
    }
  });
}

function verbesEnAttenteDeRevision() {
  const maintenant = Date.now();
  return verbes.filter(v => stats[v.inf]?.nextReview <= maintenant);
}



function envoyerNotification(nb) {
  if (Notification.permission !== "granted") return;

  new Notification("ğŸ“˜ RÃ©vision d'anglais", {
    body: `Tu as ${nb} verbe(s) Ã  rÃ©viser aujourdâ€™hui ğŸ’ª`,
  });
}

verifierRevisions();
setInterval(verifierRevisions, 60 * 60 * 1000); // toutes les heures


function desactiverNotifications() {
  localStorage.setItem("notificationsActivees", "false");
  localStorage.removeItem("derniereNotification");

  alert("ğŸ”• Notifications dÃ©sactivÃ©es");

  document.getElementById("btnActiverNotif").classList.remove("hidden");
  document.getElementById("btnDesactiverNotif").classList.add("hidden");
}

function majBoutonsNotifications() {
  const actives = localStorage.getItem("notificationsActivees") === "true";

  document.getElementById("btnActiverNotif").classList.toggle("hidden", actives);
  document.getElementById("btnDesactiverNotif").classList.toggle("hidden", !actives);
}

majBoutonsNotifications();

document.getElementById("etatNotif").textContent =
  localStorage.getItem("notificationsActivees") === "true"
  ? "ğŸ”” ActivÃ©es"
  : "ğŸ”• DÃ©sactivÃ©es";


// ================== PALIERS ==================
function getNombrePaliersDebloques() {
  let paliers = 1;
  while (true) {
    const debut = (paliers - 1) * TAILLE_PALIER;
    const groupe = verbes.slice(debut, debut + TAILLE_PALIER);
    if (groupe.length < TAILLE_PALIER) break;
    if (groupe.every(v => stats[v.inf].maitrise >= SEUIL_MAITRISE)) paliers++;
    else break;
  }
  return paliers;
}

function verbesDisponibles() {
  const groupes = groupesDebloques();
  let maxIndex = groupes.length * TAILLE_GROUPE;

  // RÃ©activation de verbes anciens (spaced repetition)
  let anciens = verbesActifs.slice(0, maxIndex - TAILLE_GROUPE);
  let nouveaux = verbesActifs.slice(0, maxIndex);

  return Math.random() < 0.3 && anciens.length ? anciens : nouveaux;
}

function choisirVerbe() {
  const verbesDisponibles = getVerbesDebloques(verbesActifs);

  // rÃ©activation d'anciens verbes (oubli contrÃ´lÃ©)
  const anciens = verbesDisponibles.filter(v =>
    stats[v.inf].erreurs > stats[v.inf].maitrise
  );

  let pool = verbesDisponibles;

  // 30 % de chance de revoir un ancien verbe
  if (anciens.length > 0 && Math.random() < 0.3) {
    pool = anciens;
  }

  return pool[Math.floor(Math.random() * pool.length)];
}

function afficherStats() {
  document.getElementById("menu").classList.add("hidden");
  document.getElementById("quiz").classList.add("hidden");
  document.getElementById("statsPanel").classList.remove("hidden");

  let total = 0, erreurs = 0, maitrise = 0;

  Object.values(stats).forEach(s => {
    total += s.propositions;
    erreurs += s.erreurs;
    maitrise += s.maitrise;
  });

  const groupes = groupesDebloques();

  let html = `
    <p>ğŸ“˜ RÃ©ponses totales : <strong>${total}</strong></p>
    <p>âŒ Erreurs : <strong>${erreurs}</strong></p>
    <p>â­ MaÃ®trises : <strong>${maitrise}</strong></p>
    <hr>
    <h3>ğŸ“¦ Groupes dÃ©bloquÃ©s</h3>
  `;

  groupes.forEach((g, i) => {
    html += `
      <p>
        Groupe ${i + 1} (verbes ${g.debut}â€“${g.fin}) :
        ${g.debloque ? "âœ… DÃ©bloquÃ©" : "ğŸ”’ VerrouillÃ©"}
      </p>
    `;
  });

  document.getElementById("statsContent").innerHTML = html;
  const streak = JSON.parse(localStorage.getItem("streak")) || { count: 0 };

html += `
  <hr>
  <h3>ğŸ”¥ SÃ©rie de jours</h3>
  <p>
    SÃ©rie actuelle :
    <strong style="font-size:18px;">
      ${streak.count} jour${streak.count > 1 ? "s" : ""}
    </strong>
  </p>
`;

html += `
  <hr>
  <h3>ğŸ† SuccÃ¨s</h3>
`;

SUCCES.forEach(s => {
  const debloque = succesState.debloques.includes(s.id);
  html += `
    <div style="
      padding:8px;
      margin-bottom:6px;
      border-radius:6px;
      background:${debloque ? "#d4edda" : "#eee"};
      opacity:${debloque ? "1" : "0.5"};
    ">
      <strong>${debloque ? "âœ…" : "ğŸ”’"} ${s.titre}</strong><br>
      <small>${s.description}</small>
    </div>
  `;
});

  document.getElementById("statsContent").innerHTML = html;

}

function fermerStats() {
  document.getElementById("statsPanel").classList.add("hidden");
  document.getElementById("menu").classList.remove("hidden");
}


// =========== STREAK JOURNALIER ==================
function majStreak() {
  const today = new Date().toISOString().slice(0, 10);

  if (streak.lastDate === today) return; // dÃ©jÃ  comptÃ© aujourdâ€™hui

  if (!streak.lastDate) {
    streak.count = 1;
  } else {
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const yestStr = yesterday.toISOString().slice(0, 10);

    if (streak.lastDate === yestStr) {
      streak.count++;
    } else {
      streak.count = 1; // streak cassÃ©e
    }
  }

  streak.lastDate = today;
  localStorage.setItem("streak", JSON.stringify(streak));
}


// ================== QUIZ ==================
function start(m) {
  mode = m;
  menu.classList.add("hidden");
  quiz.classList.remove("hidden");
  next();
}

function next() {
  current = choisirVerbe();
  stats[current.inf].propositions++;

  questionType = QUESTION_TYPES[Math.floor(Math.random()*QUESTION_TYPES.length)];

  inf.textContent = "";
  sens.textContent = "";
  extraInput.value = "";
  pres.value = pret.value = parf.value = "";

  extraLabel.classList.add("hidden");
  presLabel.classList.remove("hidden");
  pretLabel.classList.remove("hidden");
  parfLabel.classList.remove("hidden");

  if (questionType === "classique") {
    inf.textContent = current.inf;
    sens.textContent = current.sens;
  }

  if (questionType === "sens_inf") {
    sens.textContent = current.sens;
    extraLabel.classList.remove("hidden");
    presLabel.classList.add("hidden");
    pretLabel.classList.add("hidden");
    parfLabel.classList.add("hidden");
  }

  if (questionType === "inf_sens") {
    inf.textContent = current.inf;
    extraLabel.classList.remove("hidden");
    presLabel.classList.add("hidden");
    pretLabel.classList.add("hidden");
    parfLabel.classList.add("hidden");
  }

  result.innerHTML = "";
  nextBtn.classList.add("hidden");
  messageEncouragement.classList.add("hidden");
}

function normaliserAvancee(texte) {
  return texte
    .trim()
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "");
}

function reponseCorrecte(userInput, solutions) {
  const user = normaliserAvancee(userInput);
  return solutions
    .split(/[,/]/)
    .map(s => normaliserAvancee(s))
    .some(s => s === user);
}

function comparaisonVisuelle(userInput, solution) { //affiche quels sont les erreurs caractÃ¨res par caractÃ¨res
  let html = "";
  const max = Math.max(userInput.length, solution.length);

  for (let i = 0; i < max; i++) {
    const u = userInput[i] || "";
    const s = solution[i] || "";

    if (u === s) {
      html += `<span style="color:green">${u}</span>`;
    } else {
      html += `<span style="color:red">${u || "â£"}</span>`;
    }
  }
  return html;
}



function check() {
  let score = 0;
  let feedback = "";

  if (questionType === "classique") {

    if (normaliserAvancee(pres.value) === normaliserAvancee(current.pres)) {
      score++;
    } else {
      feedback += `<br>PrÃ©sent : ${comparaisonVisuelle(pres.value, current.pres)}`;
    }

    if (normaliserAvancee(pret.value) === normaliserAvancee(current.pret)) {
      score++;
    } else {
      feedback += `<br>PrÃ©tÃ©rit : ${comparaisonVisuelle(pret.value, current.pret)}`;
    }

    if (normaliserAvancee(parf.value) === normaliserAvancee(current.parf)) {
      score++;
    } else {
      feedback += `<br>Parfait : ${comparaisonVisuelle(parf.value, current.parf)}`;
    }
  }

  if (questionType === "sens_inf") {
    if (reponseCorrecte(extraInput.value, current.inf)) score = 3;
    else feedback = comparaisonVisuelle(extraInput.value, current.inf);
  }

  if (questionType === "inf_sens") {
    if (reponseCorrecte(extraInput.value, current.sens)) score = 3;
    else feedback = comparaisonVisuelle(extraInput.value, current.sens.split(/[,/]/)[0]);
  }

if (score === 3) {
  stats[current.inf].maitrise++;
  youpiAudio.play();
  animationBonneReponse();
}
 else {
    stats[current.inf].erreurs++;
    eOhAudio.play();
  }

  localStorage.setItem("stats", JSON.stringify(stats));

  result.innerHTML = `
    <strong>Correction :</strong><br>
    Infinitif : ${current.inf}<br>
    Sens : ${current.sens}<br>
    PrÃ©sent : ${current.pres}<br>
    PrÃ©tÃ©rit : ${current.pret}<br>
    Parfait : ${current.parf}<br>
    ğŸ¯ Score : ${score}/3
    ${feedback ? "<hr>ğŸ›  DÃ©tails :<br>" + feedback : ""}
  `;

  if (score === 3) nextBtn.classList.remove("hidden");
  else messageEncouragement.classList.remove("hidden");
  majStreak();
  if (score === 3) {
  succesState.perfectStreak++;
} else {
  succesState.perfectStreak = 0;
}

verifierSucces();
localStorage.setItem("succes", JSON.stringify(succesState));

}


// IMPORTER EXPORTER STATISTIQUE



function exporterDonnees() {
  const data = {
    stats: JSON.parse(localStorage.getItem("stats")) || {},
    progression: JSON.parse(localStorage.getItem("progression")) || {},
    streak: JSON.parse(localStorage.getItem("streak")) || {},
    notificationsActivees: localStorage.getItem("notificationsActivees"),
    derniereNotification: localStorage.getItem("derniereNotification"),
    dateExport: new Date().toISOString()
  };

  const blob = new Blob([JSON.stringify(data, null, 2)], {
    type: "application/json"
  });

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "verbes_anglais_stats.json";
  a.click();
  URL.revokeObjectURL(url);
}

function importerDonnees() {
  document.getElementById("importFile").click();
}

document.getElementById("importFile").addEventListener("change", function () {
  const file = this.files[0];
  if (!file) return;

  const reader = new FileReader();

  reader.onload = function (e) {
    try {
      const data = JSON.parse(e.target.result);

      if (!data.stats) throw "Fichier invalide";

      localStorage.setItem("stats", JSON.stringify(data.stats));
      localStorage.setItem("progression", JSON.stringify(data.progression || {}));
      localStorage.setItem("streak", JSON.stringify(data.streak || {count:0}));
      localStorage.setItem("notificationsActivees", data.notificationsActivees || "false");

      if (data.derniereNotification) {
        localStorage.setItem("derniereNotification", data.derniereNotification);
      }

      alert("âœ… Statistiques importÃ©es avec succÃ¨s !");
      location.reload();

    } catch (err) {
      alert("âŒ Fichier invalide ou corrompu");
    }
  };

  reader.readAsText(file);
});




//======= PDF EXPORTER ======


function exporterPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const stats = JSON.parse(localStorage.getItem("stats")) || {};
  const streak = JSON.parse(localStorage.getItem("streak")) || { count: 0 };

  let y = 15;

  // ğŸ“˜ Titre
  doc.setFontSize(18);
  doc.text("RÃ©vision des verbes anglais", 10, y);
  y += 10;

  doc.setFontSize(10);
  doc.text(`ExportÃ© le : ${new Date().toLocaleDateString()}`, 10, y);
  y += 10;

  // ğŸ”¥ Streak
  doc.setFontSize(12);
  doc.text(`Streak actuel : ${streak.count || 0} jour(s)`, 10, y);
  y += 10;

  // ğŸ“Š Stats globales
  let total = 0, mait = 0, erreurs = 0;

  Object.values(stats).forEach(v => {
    total += v.propositions || 0;
    mait += v.maitrise || 0;
    erreurs += v.erreurs || 0;
  });

  doc.text(`Statistiques globales`, 10, y);
  y += 6;
  doc.text(`â€¢ Tentatives : ${total}`, 12, y); y += 5;
  doc.text(`â€¢ MaÃ®trises : ${mait}`, 12, y); y += 5;
  doc.text(`â€¢ Erreurs : ${erreurs}`, 12, y); y += 10;

  // ğŸ”“ Groupes dÃ©bloquÃ©s
  const groupesDebloques = Math.floor(
    Object.values(stats).filter(v => v.maitrise >= 3).length / 5
  );

  doc.text(`Groupes dÃ©bloquÃ©s : ${groupesDebloques}`, 10, y);
  y += 10;

  // ğŸ§  Verbes maÃ®trisÃ©s
  doc.text("Verbes maÃ®trisÃ©s :", 10, y);
  y += 6;

  Object.entries(stats)
    .filter(([_, v]) => v.maitrise >= 3)
    .slice(0, 15)
    .forEach(([inf]) => {
      doc.text(`â€¢ ${inf}`, 12, y);
      y += 5;
    });

  y += 5;

  // âš ï¸ Verbes Ã  revoir
  doc.text("Verbes Ã  revoir :", 10, y);
  y += 6;

  Object.entries(stats)
    .filter(([_, v]) => v.erreurs > v.maitrise)
    .slice(0, 10)
    .forEach(([inf]) => {
      doc.text(`â€¢ ${inf}`, 12, y);
      y += 5;
    });

  // ğŸ“„ TÃ©lÃ©chargement
  doc.save("verbes_anglais_progression.pdf");
}

// =========  OUVRIR VERBES PERSO ===========

function ouvrirVerbesPerso() {
  document.getElementById("menu").classList.add("hidden");
  document.getElementById("quiz").classList.add("hidden");
  document.getElementById("verbesPerso").classList.remove("hidden");
  afficherListes();
//  afficherVerbesPerso();
}

function afficherVerbesListe() {
  const div = document.getElementById("listeVerbesPerso");
  const liste = listesPerso[listePersoActive];

  div.innerHTML = "<h4>ğŸ“– Verbes</h4>";

  liste.forEach((v, i) => {
    div.innerHTML += `
      <div>
        ${v.inf} â€“ ${v.sens}
        <button onclick="supprimerVerbeListe(${i})">âŒ</button>
      </div>
    `;
  });
}

function supprimerVerbeListe(index) {
  listesPerso[listePersoActive].splice(index, 1);
  localStorage.setItem("listesPerso", JSON.stringify(listesPerso));
  afficherVerbesListe();
}


function ouvrirListe(nom) {
  listePersoActive = nom;
  document.getElementById("gestionListe").classList.remove("hidden");
  document.getElementById("titreListe").textContent = `ğŸ“˜ ${nom}`;
  afficherVerbesListe();
}

function ajouterVerbePerso() {
  if (!listePersoActive) return;

  const v = {
    inf: p_inf.value.trim(),
    pres: p_pres.value.trim(),
    pret: p_pret.value.trim(),
    parf: p_parf.value.trim(),
    sens: p_sens.value.trim()
  };

  if (Object.values(v).some(x => !x)) {
    alert("Tous les champs sont requis");
    return;
  }

  listesPerso[listePersoActive].push(v);
  localStorage.setItem("listesPerso", JSON.stringify(listesPerso));

  if (!stats[v.inf]) {
    stats[v.inf] = { propositions: 0, erreurs: 0, maitrise: 0 };
    localStorage.setItem("stats", JSON.stringify(stats));
  }

  ["p_inf","p_pres","p_pret","p_parf","p_sens"].forEach(id => {
    document.getElementById(id).value = "";
  });

  afficherVerbesListe();
}

function reviserListePerso() {
  const liste = listesPerso[listePersoActive];
  if (!liste.length) {
    alert("Liste vide");
    return;
  }

  verbesActifs = liste;
  mode = "random";

  document.getElementById("verbesPerso").classList.add("hidden");
  document.getElementById("quiz").classList.remove("hidden");

  next();
}


function supprimerVerbePerso(index) {
  const inf = verbesPersonnalises[index].inf;
  verbesPersonnalises.splice(index, 1);

  delete stats[inf];

  localStorage.setItem("verbesPerso", JSON.stringify(verbesPersonnalises));
  localStorage.setItem("stats", JSON.stringify(stats));
  afficherVerbesPerso();
}

function reviserVerbesPerso() {
  if (verbesPersonnalises.length === 0) {
    alert("Aucun verbe personnalisÃ©");
    return;
  }

  verbesActifs = verbesPersonnalises;
  mode = "random";

  document.getElementById("verbesPerso").classList.add("hidden");
  document.getElementById("quiz").classList.remove("hidden");

  next();
}

function exporterListe() {
  if (!listePersoActive) return;

  const data = {
    nom: listePersoActive,
    verbes: listesPerso[listePersoActive]
  };

  const blob = new Blob(
    [JSON.stringify(data, null, 2)],
    { type: "application/json" }
  );

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `${listePersoActive.replace(/\s+/g, "_")}.json`;
  a.click();

  URL.revokeObjectURL(url);
}

function importerListe(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);

      if (!data.nom || !Array.isArray(data.verbes)) {
        throw "Format invalide";
      }

      let nom = data.nom;

      // Ã©viter Ã©crasement
      if (listesPerso[nom]) {
        let i = 2;
        while (listesPerso[`${nom} (${i})`]) i++;
        nom = `${nom} (${i})`;
      }

      listesPerso[nom] = data.verbes;

      // init stats si absentes
      data.verbes.forEach(v => {
        if (!stats[v.inf]) {
          stats[v.inf] = { propositions: 0, erreurs: 0, maitrise: 0 };
        }
      });

      localStorage.setItem("listesPerso", JSON.stringify(listesPerso));
      localStorage.setItem("stats", JSON.stringify(stats));

      afficherListes();
      alert(`Liste "${nom}" importÃ©e avec succÃ¨s`);
    } catch (e) {
      alert("âŒ Fichier invalide");
    }
  };

  reader.readAsText(file);
}

// =============== AFFICHER TOUS LES VERBES DANS STATISTIQUE ======================
function afficherTousLesVerbes() {
  const container = document.getElementById("listeCompleteVerbes");
  container.classList.remove("hidden");

  // fusion verbes de base + verbes personnalisÃ©s
  let tousLesVerbes = [...verbes];
  cacheTousLesVerbes = tousLesVerbes;

  Object.values(listesPerso).forEach(liste => {
    liste.forEach(v => {
      if (!tousLesVerbes.find(x => x.inf === v.inf)) {
        tousLesVerbes.push(v);
      }
    });
  });

let html = `
  <hr>
  <h3>ğŸ“‹ Tous les verbes</h3>

  <div style="margin-bottom:10px;">
    <button onclick="filtrerVerbes('tous')">ğŸ“‹ Tous</button>
    <button onclick="filtrerVerbes('probleme')">ğŸ”´ ProblÃ©matiques</button>
    <button onclick="filtrerVerbes('maitrise')">ğŸŸ¢ MaÃ®trisÃ©s</button>
    <button onclick="filtrerVerbes('encours')">âšª En cours</button>
    <button onclick="reviserVerbesProblemes()">ğŸ¯ RÃ©viser les verbes problÃ©matiques</button>
  </div>

  <table style="width:100%; border-collapse:collapse;">
    <thead>
      <tr style="background:#eee;">
        <th>Infinitif</th>
        <th>Sens</th>
        <th>â­ MaÃ®trise</th>
        <th>âŒ Erreurs</th>
        <th>ğŸ” ProposÃ©</th>
      </tr>
    </thead>
    <tbody id="tbodyVerbes">
`;


  tousLesVerbes.forEach(v => {
    const s = stats[v.inf] || { propositions: 0, erreurs: 0, maitrise: 0 };

    let classe = "verbe-neutre";

    if (s.erreurs > s.maitrise) {
      classe = "verbe-probleme";
    } else if (s.maitrise >= 3 && s.erreurs <= s.maitrise) {
      classe = "verbe-maitrise";
    }

    html += `
      <tr class="${classe}">
        <td>${v.inf}</td>
        <td>${v.sens}</td>
        <td style="text-align:center;">${s.maitrise}</td>
        <td style="text-align:center;">${s.erreurs}</td>
        <td style="text-align:center;">${s.propositions}</td>
      </tr>
    `;
  });


  html += `</table>
    <button onclick="fermerListeComplete()">â¬† Masquer</button>
  `;

  container.innerHTML = html;
}

function fermerListeComplete() {
  document.getElementById("listeCompleteVerbes").classList.add("hidden");
}

// filtrer les verbes

function filtrerVerbes(type) {
  const rows = document.querySelectorAll("#tbodyVerbes tr");

  rows.forEach(row => {
    row.style.display = "";

    if (type === "probleme" && !row.classList.contains("verbe-probleme")) {
      row.style.display = "none";
    }

    if (type === "maitrise" && !row.classList.contains("verbe-maitrise")) {
      row.style.display = "none";
    }

    if (type === "encours" &&
        (row.classList.contains("verbe-probleme") || row.classList.contains("verbe-maitrise"))) {
      row.style.display = "none";
    }
  });
}

// rÃ©viser les verbes problÃ©matiques
function reviserVerbesProblemes() {
  let problematiques = [];

  // verbes de base
  verbes.forEach(v => {
    const s = stats[v.inf];
    if (s && s.erreurs > s.maitrise) {
      problematiques.push(v);
    }
  });

  // verbes personnalisÃ©s
  Object.values(listesPerso).forEach(liste => {
    liste.forEach(v => {
      const s = stats[v.inf];
      if (s && s.erreurs > s.maitrise && !problematiques.find(x => x.inf === v.inf)) {
        problematiques.push(v);
      }
    });
  });

  if (problematiques.length === 0) {
    alert("ğŸ‰ Aucun verbe problÃ©matique !");
    return;
  }

  verbesActifs = problematiques;
  mode = "random";

  document.getElementById("statsPanel").classList.add("hidden");
  document.getElementById("quiz").classList.remove("hidden");

  next();
}




// update streak
document.getElementById("streakMenu").textContent =
  (JSON.parse(localStorage.getItem("streak")) || { count: 0 }).count;

</script>

</body>
</html>

