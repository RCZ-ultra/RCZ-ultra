<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>RÃ©vision des verbes allemands</title>

<style>
body {
  font-family: Arial, sans-serif;
  background:#f4f4f4;
  padding:20px;
}
.card {
  background:#fff;
  padding:20px;
  max-width:600px;
  margin:auto;
  border-radius:10px;
  box-shadow:0 2px 8px rgba(0,0,0,.1);
}
h1 { text-align:center; }
label { display:block; margin-top:10px; }
input { width:100%; padding:8px; margin-top:4px; }
button { margin-top:15px; padding:10px; width:100%; font-size:16px; }
.hidden { display:none; }
.result { margin-top:15px; }
</style>
</head>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<body>

<div class="card">
<h1>ğŸ“˜ Verbes irrÃ©guliers allemands</h1>

<div id="menu">
<!--  <button onclick="start('random')">ğŸ² Apprentissage alÃ©atoire</button> -->
  <button onclick="start('cible')">ğŸ¯ RÃ©vision ciblÃ©e</button>
  <button onclick="ouvrirVerbesPerso()">ğŸ§© Verbes personnalisÃ©s</button>
  <button onclick="afficherStats()">ğŸ“Š Statistiques</button>
<button id="btnActiverNotif" onclick="activerNotifications()">ğŸ”” Activer les notifications</button>
<button id="btnDesactiverNotif" onclick="desactiverNotifications()" class="hidden">ğŸ”• DÃ©sactiver les notifications</button>
</div>

<audio id="youpiAudio" src="youpi.mp3"></audio>
<audio id="eOhAudio" src="e_oh.mp3"></audio>

<div id="quiz" class="hidden">

  <p><strong>Infinitif :</strong> <span id="inf"></span></p>
  <p><strong>Sens :</strong> <span id="sens"></span></p>

  <label id="extraLabel" class="hidden">
    Ta rÃ©ponse
    <input id="extraInput">
  </label>

  <label id="presLabel">PrÃ©sent
    <input id="pres">
  </label>

  <label id="pretLabel">PrÃ©tÃ©rit
    <input id="pret">
  </label>

  <label id="parfLabel">Parfait
    <input id="parf">
  </label>

  <button onclick="check()">Valider</button>

  <div class="result" id="result"></div>
  <p id="messageEncouragement" class="hidden">RÃ©essaye encore ğŸ’ª</p>
  <button onclick="next()" id="nextBtn" class="hidden">â¡ï¸ Verbe suivant</button>

</div>

<div id="verbesPerso" class="hidden">
  <h2>â• Ajouter un verbe personnalisÃ©</h2>

  <label>Infinitif
    <input id="p_inf">
  </label>

  <label>PrÃ©sent
    <input id="p_pres">
  </label>

  <label>PrÃ©tÃ©rit
    <input id="p_pret">
  </label>

  <label>Parfait
    <input id="p_parf">
  </label>

  <label>Sens (sÃ©parÃ©s par ; )
    <input id="p_sens">
  </label>

  <button onclick="ajouterVerbePerso()">ğŸ’¾ Ajouter</button>
  <button onclick="reviserVerbesPerso()">ğŸ¯ RÃ©viser ces verbes</button>

  <div id="listeVerbesPerso"></div>
</div>


<div id="statsPanel" class="hidden">
  <h2>ğŸ“Š Statistiques</h2>
  <div id="statsContent"></div>
  <p>
  Notifications :
  <strong id="etatNotif"></strong>
</p>
<button onclick="exporterDonnees()">ğŸ’¾ Exporter mes statistiques</button>
<button onclick="importerDonnees()">ğŸ“‚ Importer des statistiques</button>
<button onclick="exporterPDF()">ğŸ“„ GÃ©nÃ©rer un PDF de mes statistiques</button>

<input type="file" id="importFile" accept=".json" class="hidden">

  <button onclick="fermerStats()">â¬… Retour</button>
</div>
</div>

<script>
// ================== PARAMÃˆTRES ==================
const TAILLE_PALIER = 5;
const SEUIL_MAITRISE = 3;
const TAUX_REVISION = 0.2;
const QUESTION_TYPES = ["classique", "sens_inf", "inf_sens"];

// ================== VERBES ==================
const verbes = [
  { inf: "beginnen", pres: "er beginnt", pret: "er begann", parf: "er hat begonnen", sens: "commencer" },
  { inf: "bleiben", pres: "er bleibt", pret: "er blieb", parf: "er ist geblieben", sens: "rester" },
  { inf: "bringen", pres: "er bringt", pret: "er brachte", parf: "er hat gebracht", sens: "apporter" },
  { inf: "denken", pres: "er denkt", pret: "er dachte", parf: "er hat gedacht", sens: "penser" },
  { inf: "essen", pres: "er isst", pret: "er aÃŸ", parf: "er hat gegessen", sens: "manger" },
  { inf: "an/bieten", pres: "er bietet an", pret: "er bot an", parf: "er hat angeboten", sens: "offrir, proposer" },
  { inf: "aus/sehen", pres: "er sieht aus", pret: "er sah aus", parf: "er hat ausgesehen", sens: "avoir l'air" },
  { inf: "an/ziehen", pres: "er zieht an", pret: "er zog an", parf: "er hat angezogen", sens: "mettre (un vÃªtement)" },
  { inf: "an/fangen", pres: "er fÃ¤ngt an", pret: "er fing an", parf: "er hat angefangen", sens: "commencer" },
  { inf: "an/kommen", pres: "er kommt an", pret: "er kam an", parf: "er ist angekommen", sens: "arriver" },
  { inf: "aus/geben", pres: "er gibt aus", pret: "er gab aus", parf: "er hat ausgegeben", sens: "dÃ©penser" },
  { inf: "begreifen", pres: "er begreift", pret: "er begriff", parf: "er hat begriffen", sens: "comprendre" },
  { inf: "beschlieÃŸen", pres: "er beschlieÃŸt", pret: "er beschloss", parf: "er hat beschlossen", sens: "dÃ©cider" },
  { inf: "beschreiben", pres: "er beschreibt", pret: "er beschrieb", parf: "er hat beschrieben", sens: "dÃ©crire" },
  { inf: "brechen", pres: "er bricht", pret: "er brach", parf: "er hat gebrochen", sens: "casser" },
  { inf: "ein/laden", pres: "er lÃ¤dt ein", pret: "er lud ein", parf: "er hat eingeladen", sens: "inviter" },
  { inf: "ein/schlafen", pres: "er schlÃ¤ft ein", pret: "er schlief ein", parf: "er ist eingeschlafen", sens: "s'endormir" },
  { inf: "empfangen", pres: "er empfÃ¤ngt", pret: "er empfing", parf: "er hat empfangen", sens: "recevoir" },
  { inf: "empfehlen", pres: "er empfiehlt", pret: "er empfahl", parf: "er hat empfohlen", sens: "recommander" },
  { inf: "erhalten", pres: "er erhÃ¤lt", pret: "er erhielt", parf: "er hat erhalten", sens: "obtenir" },
  { inf: "ertragen", pres: "er ertrÃ¤gt", pret: "er ertrug", parf: "er hat ertragen", sens: "supporter" },
  { inf: "fahren", pres: "er fÃ¤hrt", pret: "er fuhr", parf: "er ist gefahren", sens: "aller (en vÃ©hicule)" },
  { inf: "finden", pres: "er findet", pret: "er fand", parf: "er hat gefunden", sens: "trouver" },
  { inf: "geben", pres: "er gibt", pret: "er gab", parf: "er hat gegeben", sens: "donner" },
  { inf: "gehen", pres: "er geht", pret: "er ging", parf: "er ist gegangen", sens: "aller" },
  { inf: "helfen", pres: "er hilft", pret: "er half", parf: "er hat geholfen", sens: "aider" },
  { inf: "kommen", pres: "er kommt", pret: "er kam", parf: "er ist gekommen", sens: "venir" },
  { inf: "laufen", pres: "er lÃ¤uft", pret: "er lief", parf: "er ist gelaufen", sens: "courir" },
  { inf: "lesen", pres: "er liest", pret: "er las", parf: "er hat gelesen", sens: "lire" },
  { inf: "nehmen", pres: "er nimmt", pret: "er nahm", parf: "er hat genommen", sens: "prendre" },
  { inf: "rufen", pres: "er ruft", pret: "er rief", parf: "er hat gerufen", sens: "appeler" },
  { inf: "schlafen", pres: "er schlÃ¤ft", pret: "er schlief", parf: "er hat geschlafen", sens: "dormir" },
  { inf: "sehen", pres: "er sieht", pret: "er sah", parf: "er hat gesehen", sens: "voir" },
  { inf: "sprechen", pres: "er spricht", pret: "er sprach", parf: "er hat gesprochen", sens: "parler" },
  { inf: "stehen", pres: "er steht", pret: "er stand", parf: "er hat gestanden", sens: "Ãªtre debout" },
  { inf: "tragen", pres: "er trÃ¤gt", pret: "er trug", parf: "er hat getragen", sens: "porter" },
  { inf: "treffen", pres: "er trifft", pret: "er traf", parf: "er hat getroffen", sens: "rencontrer" },
  { inf: "werden", pres: "er wird", pret: "er wurde", parf: "er ist geworden", sens: "devenir" },
  { inf: "werfen", pres: "er wirft", pret: "er warf", parf: "er hat geworfen", sens: "jeter" },
  { inf: "ziehen", pres: "er zieht", pret: "er zog", parf: "er ist gezogen", sens: "tirer / dÃ©mÃ©nager" },
  { inf: "backen", pres: "er bÃ¤ckt", pret: "er backte", parf: "er hat gebacken", sens: "cuire au four" },
  { inf: "befehlen", pres: "er befiehlt", pret: "er befahl", parf: "er hat befohlen", sens: "ordonner" },
  { inf: "biegen", pres: "er biegt", pret: "er bog", parf: "er hat gebogen", sens: "plier" },
  { inf: "bieten", pres: "er bietet", pret: "er bot", parf: "er hat geboten", sens: "offrir" },
  { inf: "binden", pres: "er bindet", pret: "er band", parf: "er hat gebunden", sens: "attacher" },
  { inf: "bitten", pres: "er bittet", pret: "er bat", parf: "er hat gebeten", sens: "demander" },
  { inf: "blasen", pres: "er blÃ¤st", pret: "er blies", parf: "er hat geblasen", sens: "souffler" },
  { inf: "fallen", pres: "er fÃ¤llt", pret: "er fiel", parf: "er ist gefallen", sens: "tomber" },
  { inf: "fangen", pres: "er fÃ¤ngt", pret: "er fing", parf: "er hat gefangen", sens: "attraper" },
  { inf: "fliegen", pres: "er fliegt", pret: "er flog", parf: "er ist geflogen", sens: "voler" },
  { inf: "flieÃŸen", pres: "er flieÃŸt", pret: "er floss", parf: "er ist geflossen", sens: "couler" },
  { inf: "frieren", pres: "er friert", pret: "er fror", parf: "er hat gefroren", sens: "avoir froid / geler" },
  { inf: "graben", pres: "er grÃ¤bt", pret: "er grub", parf: "er hat gegraben", sens: "creuser" },
  { inf: "halten", pres: "er hÃ¤lt", pret: "er hielt", parf: "er hat gehalten", sens: "tenir" },
  { inf: "hÃ¤ngen", pres: "er hÃ¤ngt", pret: "er hing", parf: "er hat gehangen", sens: "Ãªtre suspendu" },
  { inf: "heiÃŸen", pres: "er heiÃŸt", pret: "er hieÃŸ", parf: "er hat geheiÃŸen", sens: "s'appeler" },
  { inf: "kneifen", pres: "er kneift", pret: "er kniff", parf: "er hat gekniffen", sens: "pincer" },
  { inf: "laden", pres: "er lÃ¤dt", pret: "er lud", parf: "er hat geladen", sens: "charger" },
  { inf: "liegen", pres: "er liegt", pret: "er lag", parf: "er hat gelegen", sens: "Ãªtre couchÃ©" },
  { inf: "lÃ¼gen", pres: "er lÃ¼gt", pret: "er log", parf: "er hat gelogen", sens: "mentir" },
  { inf: "messen", pres: "er misst", pret: "er maÃŸ", parf: "er hat gemessen", sens: "mesurer" },
  { inf: "pfeifen", pres: "er pfeift", pret: "er pfiff", parf: "er hat gepfiffen", sens: "siffler" },
  { inf: "raten", pres: "er rÃ¤t", pret: "er riet", parf: "er hat geraten", sens: "conseiller / deviner" },
  { inf: "reiten", pres: "er reitet", pret: "er ritt", parf: "er ist geritten", sens: "monter Ã  cheval" },
  { inf: "scheinen", pres: "er scheint", pret: "er schien", parf: "er hat geschienen", sens: "briller / sembler" },
  { inf: "schlagen", pres: "er schlÃ¤gt", pret: "er schlug", parf: "er hat geschlagen", sens: "frapper" },
  { inf: "schneiden", pres: "er schneidet", pret: "er schnitt", parf: "er hat geschnitten", sens: "couper" },
  { inf: "schreien", pres: "er schreit", pret: "er schrie", parf: "er hat geschrien", sens: "crier" },
  { inf: "schweigen", pres: "er schweigt", pret: "er schwieg", parf: "er hat geschwiegen", sens: "se taire" },
  { inf: "steigen", pres: "er steigt", pret: "er stieg", parf: "er ist gestiegen", sens: "monter" }
];

// ============VERBES PERSONNALISÃ©S =================//
    let verbesPersonnalises =
        JSON.parse(localStorage.getItem("verbesPerso")) || [];

  let verbesDeBase = [...verbes];
  let verbesActifs = verbesDeBase;
// ================== NORMALISATION ==================
function normaliser(texte) {
  return texte.trim().toLowerCase();
}

// ================== VARIABLES ==================
let mode = "random";
let current = null;
let questionType = "classique";

const youpiAudio = document.getElementById("youpiAudio");
const eOhAudio = document.getElementById("eOhAudio");

let stats = JSON.parse(localStorage.getItem("stats")) || {};
verbes.forEach(v => {
  if (!stats[v.inf]) stats[v.inf] = stats[inf] = {
  propositions: 0,
  erreurs: 0,
  maitrise: 0,
  nextReview: null,   // timestamp
  interval: 0         // index dâ€™intervalle
};
;
});

const TAILLE_GROUPE = 5;

function getGroupIndex(index) {
  return Math.floor(index / TAILLE_GROUPE);
}

function groupesDebloques() {
  let groupes = [];

  for (let i = 0; i < verbes.length; i += TAILLE_GROUPE) {
    const groupe = verbes.slice(i, i + TAILLE_GROUPE);

    const maitriseOK = groupe.every(v => stats[v.inf]?.maitrise >= 1);

    groupes.push({
      debut: i + 1,
      fin: Math.min(i + TAILLE_GROUPE, verbes.length),
      debloque: maitriseOK
    });

    if (!maitriseOK) break;
  }

  return groupes;
}

// =================Notifications ========

function verifierRevisions() {
  if (localStorage.getItem("notificationsActivees") !== "true") return;

  const today = new Date().toISOString().slice(0,10);
  const derniereNotif = localStorage.getItem("derniereNotification");

  if (derniereNotif === today) return;

  const aReviser = verbesEnAttenteDeRevision();

  if (aReviser.length > 0) {
    envoyerNotification(aReviser.length);
    localStorage.setItem("derniereNotification", today);
  }
}

function activerNotifications() {
  if (!("Notification" in window)) {
    alert("Les notifications ne sont pas supportÃ©es par ce navigateur.");
    return;
  }

  Notification.requestPermission().then(permission => {
    if (permission === "granted") {
      localStorage.setItem("notificationsActivees", "true");
      alert("ğŸ”” Notifications activÃ©es !");
      verifierRevisions(); // test immÃ©diat
    } else {
      alert("Notifications refusÃ©es.");
    }
  });
}

function verbesEnAttenteDeRevision() {
  const maintenant = Date.now();
  return verbes.filter(v => stats[v.inf]?.nextReview <= maintenant);
}



function envoyerNotification(nb) {
  if (Notification.permission !== "granted") return;

  new Notification("ğŸ“˜ RÃ©vision allemande", {
    body: `Tu as ${nb} verbe(s) Ã  rÃ©viser aujourdâ€™hui ğŸ’ª`,
  });
}

verifierRevisions();
setInterval(verifierRevisions, 60 * 60 * 1000); // toutes les heures


function desactiverNotifications() {
  localStorage.setItem("notificationsActivees", "false");
  localStorage.removeItem("derniereNotification");

  alert("ğŸ”• Notifications dÃ©sactivÃ©es");

  document.getElementById("btnActiverNotif").classList.remove("hidden");
  document.getElementById("btnDesactiverNotif").classList.add("hidden");
}

function majBoutonsNotifications() {
  const actives = localStorage.getItem("notificationsActivees") === "true";

  document.getElementById("btnActiverNotif").classList.toggle("hidden", actives);
  document.getElementById("btnDesactiverNotif").classList.toggle("hidden", !actives);
}

majBoutonsNotifications();

document.getElementById("etatNotif").textContent =
  localStorage.getItem("notificationsActivees") === "true"
  ? "ğŸ”” ActivÃ©es"
  : "ğŸ”• DÃ©sactivÃ©es";


// ================== PALIERS ==================
function getNombrePaliersDebloques() {
  let paliers = 1;
  while (true) {
    const debut = (paliers - 1) * TAILLE_PALIER;
    const groupe = verbes.slice(debut, debut + TAILLE_PALIER);
    if (groupe.length < TAILLE_PALIER) break;
    if (groupe.every(v => stats[v.inf].maitrise >= SEUIL_MAITRISE)) paliers++;
    else break;
  }
  return paliers;
}

function verbesDisponibles() {
  const groupes = groupesDebloques();
  let maxIndex = groupes.length * TAILLE_GROUPE;

  // RÃ©activation de verbes anciens (spaced repetition)
  let anciens = verbesActifs.slice(0, maxIndex - TAILLE_GROUPE);
  let nouveaux = verbesActifs.slice(0, maxIndex);

  return Math.random() < 0.3 && anciens.length ? anciens : nouveaux;
}

function choisirVerbe() {
  const liste = verbesDisponibles();

  if (mode === "random") {
    return liste[Math.floor(Math.random() * liste.length)];
  }

  let cibles = liste.filter(v =>
    stats[v.inf].erreurs > stats[v.inf].maitrise ||
    stats[v.inf].maitrise < 4
  );

  return (cibles.length ? cibles : liste)[Math.floor(Math.random() * liste.length)];
}

function afficherStats() {
  document.getElementById("menu").classList.add("hidden");
  document.getElementById("quiz").classList.add("hidden");
  document.getElementById("statsPanel").classList.remove("hidden");

  let total = 0, erreurs = 0, maitrise = 0;

  Object.values(stats).forEach(s => {
    total += s.propositions;
    erreurs += s.erreurs;
    maitrise += s.maitrise;
  });

  const groupes = groupesDebloques();

  let html = `
    <p>ğŸ“˜ RÃ©ponses totales : <strong>${total}</strong></p>
    <p>âŒ Erreurs : <strong>${erreurs}</strong></p>
    <p>â­ MaÃ®trises : <strong>${maitrise}</strong></p>
    <hr>
    <h3>ğŸ“¦ Groupes dÃ©bloquÃ©s</h3>
  `;

  groupes.forEach((g, i) => {
    html += `
      <p>
        Groupe ${i + 1} (verbes ${g.debut}â€“${g.fin}) :
        ${g.debloque ? "âœ… DÃ©bloquÃ©" : "ğŸ”’ VerrouillÃ©"}
      </p>
    `;
  });

  document.getElementById("statsContent").innerHTML = html;
}

function fermerStats() {
  document.getElementById("statsPanel").classList.add("hidden");
  document.getElementById("menu").classList.remove("hidden");
}


// ================== QUIZ ==================
function start(m) {
  mode = m;
  menu.classList.add("hidden");
  quiz.classList.remove("hidden");
  next();
}

function next() {
  current = choisirVerbe();
  stats[current.inf].propositions++;

  questionType = QUESTION_TYPES[Math.floor(Math.random()*QUESTION_TYPES.length)];

  inf.textContent = "";
  sens.textContent = "";
  extraInput.value = "";
  pres.value = pret.value = parf.value = "";

  extraLabel.classList.add("hidden");
  presLabel.classList.remove("hidden");
  pretLabel.classList.remove("hidden");
  parfLabel.classList.remove("hidden");

  if (questionType === "classique") {
    inf.textContent = current.inf;
    sens.textContent = current.sens;
  }

  if (questionType === "sens_inf") {
    sens.textContent = current.sens;
    extraLabel.classList.remove("hidden");
    presLabel.classList.add("hidden");
    pretLabel.classList.add("hidden");
    parfLabel.classList.add("hidden");
  }

  if (questionType === "inf_sens") {
    inf.textContent = current.inf;
    extraLabel.classList.remove("hidden");
    presLabel.classList.add("hidden");
    pretLabel.classList.add("hidden");
    parfLabel.classList.add("hidden");
  }

  result.innerHTML = "";
  nextBtn.classList.add("hidden");
  messageEncouragement.classList.add("hidden");
}

function normaliserAvancee(texte) {
  return texte
    .trim()
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "");
}

function reponseCorrecte(userInput, solutions) {
  const user = normaliserAvancee(userInput);
  return solutions
    .split(/[,/]/)
    .map(s => normaliserAvancee(s))
    .some(s => s === user);
}

function comparaisonVisuelle(userInput, solution) {
  let html = "";
  const max = Math.max(userInput.length, solution.length);

  for (let i = 0; i < max; i++) {
    const u = userInput[i] || "";
    const s = solution[i] || "";

    if (u === s) {
      html += `<span style="color:green">${u}</span>`;
    } else {
      html += `<span style="color:red">${u || "â£"}</span>`;
    }
  }
  return html;
}



function check() {
  let score = 0;
  let feedback = "";

  if (questionType === "classique") {

    if (normaliserAvancee(pres.value) === normaliserAvancee(current.pres)) {
      score++;
    } else {
      feedback += `<br>PrÃ©sent : ${comparaisonVisuelle(pres.value, current.pres)}`;
    }

    if (normaliserAvancee(pret.value) === normaliserAvancee(current.pret)) {
      score++;
    } else {
      feedback += `<br>PrÃ©tÃ©rit : ${comparaisonVisuelle(pret.value, current.pret)}`;
    }

    if (normaliserAvancee(parf.value) === normaliserAvancee(current.parf)) {
      score++;
    } else {
      feedback += `<br>Parfait : ${comparaisonVisuelle(parf.value, current.parf)}`;
    }
  }

  if (questionType === "sens_inf") {
    if (reponseCorrecte(extraInput.value, current.inf)) score = 3;
    else feedback = comparaisonVisuelle(extraInput.value, current.inf);
  }

  if (questionType === "inf_sens") {
    if (reponseCorrecte(extraInput.value, current.sens)) score = 3;
    else feedback = comparaisonVisuelle(extraInput.value, current.sens.split(/[,/]/)[0]);
  }

  if (score === 3) {
    stats[current.inf].maitrise++;
    youpiAudio.play();
  } else {
    stats[current.inf].erreurs++;
    eOhAudio.play();
  }

  localStorage.setItem("stats", JSON.stringify(stats));

  result.innerHTML = `
    <strong>Correction :</strong><br>
    Infinitif : ${current.inf}<br>
    Sens : ${current.sens}<br>
    PrÃ©sent : ${current.pres}<br>
    PrÃ©tÃ©rit : ${current.pret}<br>
    Parfait : ${current.parf}<br>
    ğŸ¯ Score : ${score}/3
    ${feedback ? "<hr>ğŸ›  DÃ©tails :<br>" + feedback : ""}
  `;

  if (score === 3) nextBtn.classList.remove("hidden");
  else messageEncouragement.classList.remove("hidden");
}


// IMPORTER EXPORTER STATISTIQUE



function exporterDonnees() {
  const data = {
    stats: JSON.parse(localStorage.getItem("stats")) || {},
    progression: JSON.parse(localStorage.getItem("progression")) || {},
    streak: JSON.parse(localStorage.getItem("streak")) || {},
    notificationsActivees: localStorage.getItem("notificationsActivees"),
    derniereNotification: localStorage.getItem("derniereNotification"),
    dateExport: new Date().toISOString()
  };

  const blob = new Blob([JSON.stringify(data, null, 2)], {
    type: "application/json"
  });

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "verbes_allemands_stats.json";
  a.click();
  URL.revokeObjectURL(url);
}

function importerDonnees() {
  document.getElementById("importFile").click();
}

document.getElementById("importFile").addEventListener("change", function () {
  const file = this.files[0];
  if (!file) return;

  const reader = new FileReader();

  reader.onload = function (e) {
    try {
      const data = JSON.parse(e.target.result);

      if (!data.stats) throw "Fichier invalide";

      localStorage.setItem("stats", JSON.stringify(data.stats));
      localStorage.setItem("progression", JSON.stringify(data.progression || {}));
      localStorage.setItem("streak", JSON.stringify(data.streak || {count:0}));
      localStorage.setItem("notificationsActivees", data.notificationsActivees || "false");

      if (data.derniereNotification) {
        localStorage.setItem("derniereNotification", data.derniereNotification);
      }

      alert("âœ… Statistiques importÃ©es avec succÃ¨s !");
      location.reload();

    } catch (err) {
      alert("âŒ Fichier invalide ou corrompu");
    }
  };

  reader.readAsText(file);
});




//======= PDF EXPORTER ======


function exporterPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const stats = JSON.parse(localStorage.getItem("stats")) || {};
  const streak = JSON.parse(localStorage.getItem("streak")) || { count: 0 };

  let y = 15;

  // ğŸ“˜ Titre
  doc.setFontSize(18);
  doc.text("RÃ©vision des verbes allemands", 10, y);
  y += 10;

  doc.setFontSize(10);
  doc.text(`ExportÃ© le : ${new Date().toLocaleDateString()}`, 10, y);
  y += 10;

  // ğŸ”¥ Streak
  doc.setFontSize(12);
  doc.text(`ğŸ”¥ Streak actuel : ${streak.count || 0} jour(s)`, 10, y);
  y += 10;

  // ğŸ“Š Stats globales
  let total = 0, mait = 0, erreurs = 0;

  Object.values(stats).forEach(v => {
    total += v.propositions || 0;
    mait += v.maitrise || 0;
    erreurs += v.erreurs || 0;
  });

  doc.text(`ğŸ“Š Statistiques globales`, 10, y);
  y += 6;
  doc.text(`â€¢ Tentatives : ${total}`, 12, y); y += 5;
  doc.text(`â€¢ MaÃ®trises : ${mait}`, 12, y); y += 5;
  doc.text(`â€¢ Erreurs : ${erreurs}`, 12, y); y += 10;

  // ğŸ”“ Groupes dÃ©bloquÃ©s
  const groupesDebloques = Math.floor(
    Object.values(stats).filter(v => v.maitrise >= 3).length / 5
  );

  doc.text(`ğŸ”“ Groupes dÃ©bloquÃ©s : ${groupesDebloques}`, 10, y);
  y += 10;

  // ğŸ§  Verbes maÃ®trisÃ©s
  doc.text("ğŸ§  Verbes maÃ®trisÃ©s :", 10, y);
  y += 6;

  Object.entries(stats)
    .filter(([_, v]) => v.maitrise >= 3)
    .slice(0, 15)
    .forEach(([inf]) => {
      doc.text(`â€¢ ${inf}`, 12, y);
      y += 5;
    });

  y += 5;

  // âš ï¸ Verbes Ã  revoir
  doc.text("âš ï¸ Verbes Ã  revoir :", 10, y);
  y += 6;

  Object.entries(stats)
    .filter(([_, v]) => v.erreurs > v.maitrise)
    .slice(0, 10)
    .forEach(([inf]) => {
      doc.text(`â€¢ ${inf}`, 12, y);
      y += 5;
    });

  // ğŸ“„ TÃ©lÃ©chargement
  doc.save("verbes_allemands_progression.pdf");
}

// =========  OUVRIR VERBES PERSO ===========

function ouvrirVerbesPerso() {
  document.getElementById("menu").classList.add("hidden");
  document.getElementById("quiz").classList.add("hidden");
  document.getElementById("verbesPerso").classList.remove("hidden");
  afficherVerbesPerso();
}

function ajouterVerbePerso() {
  const v = {
    inf: p_inf.value.trim(),
    pres: p_pres.value.trim(),
    pret: p_pret.value.trim(),
    parf: p_parf.value.trim(),
    sens: p_sens.value.trim()
  };

  if (!v.inf || !v.pres || !v.pret || !v.parf || !v.sens) {
    alert("Tous les champs sont obligatoires");
    return;
  }

  verbesPersonnalises.push(v);
  localStorage.setItem("verbesPerso", JSON.stringify(verbesPersonnalises));

  // stats initiales
  stats[v.inf] = { propositions: 0, erreurs: 0, maitrise: 0 };
  localStorage.setItem("stats", JSON.stringify(stats));

  ["p_inf","p_pres","p_pret","p_parf","p_sens"].forEach(id => {
    document.getElementById(id).value = "";
  });

  afficherVerbesPerso();
}
function afficherVerbesPerso() {
  const div = document.getElementById("listeVerbesPerso");
  div.innerHTML = "<h3>ğŸ“š Mes verbes</h3>";

  verbesPersonnalises.forEach((v, i) => {
    div.innerHTML += `
      <div>
        ${v.inf} â€“ ${v.sens}
        <button onclick="supprimerVerbePerso(${i})">âŒ</button>
      </div>
    `;
  });
}

function supprimerVerbePerso(index) {
  const inf = verbesPersonnalises[index].inf;
  verbesPersonnalises.splice(index, 1);

  delete stats[inf];

  localStorage.setItem("verbesPerso", JSON.stringify(verbesPersonnalises));
  localStorage.setItem("stats", JSON.stringify(stats));
  afficherVerbesPerso();
}

function reviserVerbesPerso() {
  if (verbesPersonnalises.length === 0) {
    alert("Aucun verbe personnalisÃ©");
    return;
  }

  verbesActifs = verbesPersonnalises;
  mode = "random";

  document.getElementById("verbesPerso").classList.add("hidden");
  document.getElementById("quiz").classList.remove("hidden");

  next();
}


</script>

</body>
</html>

