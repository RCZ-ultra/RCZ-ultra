<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>RÃ©vision des verbes allemands</title>

<style>
body {
  font-family: Arial, sans-serif;
  background:#f4f4f4;
  padding:20px;
}
.card {
  background:#fff;
  padding:20px;
  max-width:600px;
  margin:auto;
  border-radius:10px;
  box-shadow:0 2px 8px rgba(0,0,0,.1);
}
h1 { text-align:center; }
label { display:block; margin-top:10px; }
input { width:100%; padding:8px; margin-top:4px; }
button { margin-top:15px; padding:10px; width:100%; font-size:16px; }
.hidden { display:none; }
.result { margin-top:15px; }

table td, table th {
  border: 1px solid #ccc;
  padding: 6px;
  font-size: 14px;
}

table tr:nth-child(even) {
  background: #fafafa;
}

.verbe-maitrise {
  background: #d4edda;
  color: #155724;
}

.verbe-probleme {
  background: #f8d7da;
  color: #721c24;
}

.verbe-neutre {
  background: #ffffff;
}

.verbe-maitrise td,
.verbe-probleme td,
.verbe-neutre td {
  border: 1px solid #ccc;
  padding: 6px;
}

@keyframes successFlash {
  0%   { background-color: #ffffff; }
  30%  { background-color: #d4edda; }
  100% { background-color: #ffffff; }
}

@keyframes successPop {
  0%   { transform: scale(1); }
  40%  { transform: scale(1.05); }
  100% { transform: scale(1); }
}

.success-animation {
  animation: successFlash 0.6s ease, successPop 0.4s ease;
}

</style>
</head>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script> <!-- La librairie jspdf est utilisÃ© pour gÃ©nÃ©rer le PDF des statistiques -->

<body>

<div class="card">
<h1>ğŸ“˜ Verbes irrÃ©guliers allemands</h1>

<div id="menu">
<!--  <button onclick="start('random')">ğŸ² Apprentissage alÃ©atoire</button> -->
  <button onclick="start('cible')">ğŸ¯ RÃ©vision ciblÃ©e</button>
  <button onclick="ouvrirVerbesPerso()">ğŸ§© Listes de verbes personnalisÃ©es</button>
  <button onclick="afficherStats()">ğŸ“Š Statistiques</button>
<button id="btnActiverNotif" onclick="activerNotifications()">ğŸ”” Activer les notifications</button>
<button id="btnDesactiverNotif" onclick="desactiverNotifications()" class="hidden">ğŸ”• DÃ©sactiver les notifications</button>
<p style="text-align:center; margin-top:10px;">
  ğŸ”¥ SÃ©rie actuelle : <strong id="streakMenu">0</strong> jour(s)
</p>

</div>

<audio id="youpiAudio" src="youpi.mp3"></audio>
<audio id="eOhAudio" src="e_oh.mp3"></audio>

<div id="quiz" class="hidden">

  <p><strong>Infinitif :</strong> <span id="inf"></span></p>
  <p><strong>Sens :</strong> <span id="sens"></span></p>

  <label id="extraLabel" class="hidden">
    Ta rÃ©ponse
    <input id="extraInput" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  </label>

  <label id="presLabel">PrÃ©sent
    <input id="pres" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  </label>

  <label id="pretLabel">PrÃ©tÃ©rit
    <input id="pret" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  </label>

  <label id="parfLabel">Parfait
    <input id="parf" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  </label>

  <button onclick="check()">Valider</button>

  <div class="result" id="result"></div>
  <p id="messageEncouragement" class="hidden">RÃ©essaye encore ğŸ’ª</p>
  <button onclick="next()" id="nextBtn" class="hidden">â¡ï¸ Verbe suivant</button>

</div>

<div id="verbesPerso" class="hidden">
  <h2>ğŸ“‚ Mes listes de verbes</h2>

  <label>Nouvelle liste
    <input id="nomListe">
  </label>
  <button onclick="creerListe()">â• CrÃ©er la liste</button>

  <div id="listesExistantes"></div>

  <hr>

  <div id="gestionListe" class="hidden">
    <h3 id="titreListe"></h3>

<label>Infinitif
  <input id="p_inf" onblur="autoCompleterVerbe()">
</label>

    <label>PrÃ©sent <input id="p_pres"></label>
    <label>PrÃ©tÃ©rit <input id="p_pret"></label>
    <label>Parfait <input id="p_parf"></label>
    <label>Sens ( ; pour sÃ©parer) <input id="p_sens"></label>

    <button onclick="ajouterVerbePerso()">ğŸ’¾ Ajouter le verbe</button>
    <button onclick="reviserListePerso()">ğŸ¯ RÃ©viser cette liste</button>
    <button onclick="exporterListe()">ğŸ“¤ Exporter la liste</button>

<label style="margin-top:10px;">
  ğŸ“¥ Importer une liste
  <input type="file" id="importListeInput" accept=".json" onchange="importerListe(event)">
</label>


    <div id="listeVerbesPerso"></div>
  </div>
</div>



<div id="statsPanel" class="hidden">
  <h2>ğŸ“Š Statistiques</h2>
  <div id="statsContent"></div>
  <div id="listeCompleteVerbes" class="hidden"></div>
  <p>
  Notifications :
  <strong id="etatNotif"></strong>
</p>
<button onclick="exporterDonnees()">ğŸ’¾ Exporter mes progrÃ¨s et statistiques</button>
<button onclick="importerDonnees()">ğŸ“‚ Importer mes progrÃ¨s et statistiques</button>
<button onclick="exporterPDF()">ğŸ“„ GÃ©nÃ©rer un PDF de mes statistiques</button>
<button onclick="afficherTousLesVerbes()">ğŸ“‹ Voir tous les verbes</button>

<input type="file" id="importFile" accept=".json" class="hidden">

  <button onclick="fermerStats()">â¬… Retour</button>
</div>
</div>

<script>
// ================== PARAMÃˆTRES ==================
const TAILLE_PALIER = 5;
const SEUIL_MAITRISE = 3;
const TAUX_REVISION = 0.2;
const QUESTION_TYPES = ["classique", "sens_inf", "inf_sens"];

// ================== VERBES ==================
const verbes = [
  { inf: "beginnen", pres: "er beginnt", pret: "er begann", parf: "er hat begonnen", sens: "commencer" },
  { inf: "bleiben", pres: "er bleibt", pret: "er blieb", parf: "er ist geblieben", sens: "rester" },
  { inf: "bringen", pres: "er bringt", pret: "er brachte", parf: "er hat gebracht", sens: "apporter" },
  { inf: "denken", pres: "er denkt", pret: "er dachte", parf: "er hat gedacht", sens: "penser" },
  { inf: "essen", pres: "er isst", pret: "er aÃŸ", parf: "er hat gegessen", sens: "manger" },
  { inf: "an/bieten", pres: "er bietet an", pret: "er bot an", parf: "er hat angeboten", sens: "offrir, proposer" },
  { inf: "aus/sehen", pres: "er sieht aus", pret: "er sah aus", parf: "er hat ausgesehen", sens: "avoir l'air" },
  { inf: "an/ziehen", pres: "er zieht an", pret: "er zog an", parf: "er hat angezogen", sens: "mettre (un vÃªtement)" },
  { inf: "an/fangen", pres: "er fÃ¤ngt an", pret: "er fing an", parf: "er hat angefangen", sens: "commencer" },
  { inf: "an/kommen", pres: "er kommt an", pret: "er kam an", parf: "er ist angekommen", sens: "arriver" },
  { inf: "aus/geben", pres: "er gibt aus", pret: "er gab aus", parf: "er hat ausgegeben", sens: "dÃ©penser" },
  { inf: "begreifen", pres: "er begreift", pret: "er begriff", parf: "er hat begriffen", sens: "comprendre" },
  { inf: "beschlieÃŸen", pres: "er beschlieÃŸt", pret: "er beschloss", parf: "er hat beschlossen", sens: "dÃ©cider" },
  { inf: "beschreiben", pres: "er beschreibt", pret: "er beschrieb", parf: "er hat beschrieben", sens: "dÃ©crire" },
  { inf: "brechen", pres: "er bricht", pret: "er brach", parf: "er hat gebrochen", sens: "casser" },
  { inf: "ein/laden", pres: "er lÃ¤dt ein", pret: "er lud ein", parf: "er hat eingeladen", sens: "inviter" },
  { inf: "ein/schlafen", pres: "er schlÃ¤ft ein", pret: "er schlief ein", parf: "er ist eingeschlafen", sens: "s'endormir" },
  { inf: "empfangen", pres: "er empfÃ¤ngt", pret: "er empfing", parf: "er hat empfangen", sens: "recevoir" },
  { inf: "empfehlen", pres: "er empfiehlt", pret: "er empfahl", parf: "er hat empfohlen", sens: "recommander" },
  { inf: "erhalten", pres: "er erhÃ¤lt", pret: "er erhielt", parf: "er hat erhalten", sens: "obtenir" },
  { inf: "ertragen", pres: "er ertrÃ¤gt", pret: "er ertrug", parf: "er hat ertragen", sens: "supporter" },
  { inf: "fahren", pres: "er fÃ¤hrt", pret: "er fuhr", parf: "er ist gefahren", sens: "aller (en vÃ©hicule)" },
  { inf: "finden", pres: "er findet", pret: "er fand", parf: "er hat gefunden", sens: "trouver" },
  { inf: "geben", pres: "er gibt", pret: "er gab", parf: "er hat gegeben", sens: "donner" },
  { inf: "gehen", pres: "er geht", pret: "er ging", parf: "er ist gegangen", sens: "aller" },
  { inf: "helfen", pres: "er hilft", pret: "er half", parf: "er hat geholfen", sens: "aider" },
  { inf: "kommen", pres: "er kommt", pret: "er kam", parf: "er ist gekommen", sens: "venir" },
  { inf: "laufen", pres: "er lÃ¤uft", pret: "er lief", parf: "er ist gelaufen", sens: "courir" },
  { inf: "lesen", pres: "er liest", pret: "er las", parf: "er hat gelesen", sens: "lire" },
  { inf: "nehmen", pres: "er nimmt", pret: "er nahm", parf: "er hat genommen", sens: "prendre" },
  { inf: "rufen", pres: "er ruft", pret: "er rief", parf: "er hat gerufen", sens: "appeler" },
  { inf: "schlafen", pres: "er schlÃ¤ft", pret: "er schlief", parf: "er hat geschlafen", sens: "dormir" },
  { inf: "sehen", pres: "er sieht", pret: "er sah", parf: "er hat gesehen", sens: "voir" },
  { inf: "sprechen", pres: "er spricht", pret: "er sprach", parf: "er hat gesprochen", sens: "parler" },
  { inf: "stehen", pres: "er steht", pret: "er stand", parf: "er hat gestanden", sens: "Ãªtre debout" },
  { inf: "tragen", pres: "er trÃ¤gt", pret: "er trug", parf: "er hat getragen", sens: "porter" },
  { inf: "treffen", pres: "er trifft", pret: "er traf", parf: "er hat getroffen", sens: "rencontrer" },
  { inf: "werden", pres: "er wird", pret: "er wurde", parf: "er ist geworden", sens: "devenir" },
  { inf: "werfen", pres: "er wirft", pret: "er warf", parf: "er hat geworfen", sens: "jeter" },
  { inf: "ziehen", pres: "er zieht", pret: "er zog", parf: "er ist gezogen", sens: "tirer / dÃ©mÃ©nager" },
  { inf: "backen", pres: "er bÃ¤ckt", pret: "er backte", parf: "er hat gebacken", sens: "cuire au four" },
  { inf: "befehlen", pres: "er befiehlt", pret: "er befahl", parf: "er hat befohlen", sens: "ordonner" },
  { inf: "biegen", pres: "er biegt", pret: "er bog", parf: "er hat gebogen", sens: "plier" },
  { inf: "bieten", pres: "er bietet", pret: "er bot", parf: "er hat geboten", sens: "offrir" },
  { inf: "binden", pres: "er bindet", pret: "er band", parf: "er hat gebunden", sens: "attacher" },
  { inf: "bitten", pres: "er bittet", pret: "er bat", parf: "er hat gebeten", sens: "demander" },
  { inf: "blasen", pres: "er blÃ¤st", pret: "er blies", parf: "er hat geblasen", sens: "souffler" },
  { inf: "fallen", pres: "er fÃ¤llt", pret: "er fiel", parf: "er ist gefallen", sens: "tomber" },
  { inf: "fangen", pres: "er fÃ¤ngt", pret: "er fing", parf: "er hat gefangen", sens: "attraper" },
  { inf: "fliegen", pres: "er fliegt", pret: "er flog", parf: "er ist geflogen", sens: "voler" },
  { inf: "flieÃŸen", pres: "er flieÃŸt", pret: "er floss", parf: "er ist geflossen", sens: "couler" },
  { inf: "frieren", pres: "er friert", pret: "er fror", parf: "er hat gefroren", sens: "avoir froid / geler" },
  { inf: "graben", pres: "er grÃ¤bt", pret: "er grub", parf: "er hat gegraben", sens: "creuser" },
  { inf: "halten", pres: "er hÃ¤lt", pret: "er hielt", parf: "er hat gehalten", sens: "tenir" },
  { inf: "hÃ¤ngen", pres: "er hÃ¤ngt", pret: "er hing", parf: "er hat gehangen", sens: "Ãªtre suspendu" },
  { inf: "heiÃŸen", pres: "er heiÃŸt", pret: "er hieÃŸ", parf: "er hat geheiÃŸen", sens: "s'appeler" },
  { inf: "kneifen", pres: "er kneift", pret: "er kniff", parf: "er hat gekniffen", sens: "pincer" },
  { inf: "laden", pres: "er lÃ¤dt", pret: "er lud", parf: "er hat geladen", sens: "charger" },
  { inf: "liegen", pres: "er liegt", pret: "er lag", parf: "er hat gelegen", sens: "Ãªtre couchÃ©" },
  { inf: "lÃ¼gen", pres: "er lÃ¼gt", pret: "er log", parf: "er hat gelogen", sens: "mentir" },
  { inf: "messen", pres: "er misst", pret: "er maÃŸ", parf: "er hat gemessen", sens: "mesurer" },
  { inf: "pfeifen", pres: "er pfeift", pret: "er pfiff", parf: "er hat gepfiffen", sens: "siffler" },
  { inf: "raten", pres: "er rÃ¤t", pret: "er riet", parf: "er hat geraten", sens: "conseiller / deviner" },
  { inf: "reiten", pres: "er reitet", pret: "er ritt", parf: "er ist geritten", sens: "monter Ã  cheval" },
  { inf: "scheinen", pres: "er scheint", pret: "er schien", parf: "er hat geschienen", sens: "briller / sembler" },
  { inf: "schlagen", pres: "er schlÃ¤gt", pret: "er schlug", parf: "er hat geschlagen", sens: "frapper" },
  { inf: "schneiden", pres: "er schneidet", pret: "er schnitt", parf: "er hat geschnitten", sens: "couper" },
  { inf: "schreien", pres: "er schreit", pret: "er schrie", parf: "er hat geschrien", sens: "crier" },
  { inf: "schweigen", pres: "er schweigt", pret: "er schwieg", parf: "er hat geschwiegen", sens: "se taire" },
  { inf: "steigen", pres: "er steigt", pret: "er stieg", parf: "er ist gestiegen", sens: "monter" },
  { inf: "trinken", pres: "er trinkt", pret: "er trank", parf: "er hat getrunken", sens: "boire" },
  { inf: "schreiben", pres: "er schreibt", pret: "er schrieb", parf: "er hat geschrieben", sens: "Ã©crire" },
  { inf: "singen", pres: "er singt", pret: "er sang", parf: "er hat gesungen", sens: "chanter" },
  { inf: "springen", pres: "er springt", pret: "er sprang", parf: "er ist gesprungen", sens: "sauter" },
  { inf: "schwimmen", pres: "er schwimmt", pret: "er schwamm", parf: "er ist geschwommen", sens: "nager" },
  { inf: "sterben", pres: "er stirbt", pret: "er starb", parf: "er ist gestorben", sens: "mourir" },
  { inf: "verlieren", pres: "er verliert", pret: "er verlor", parf: "er hat verloren", sens: "perdre" },
  { inf: "gewinnen", pres: "er gewinnt", pret: "er gewann", parf: "er hat gewonnen", sens: "gagner" },
  { inf: "vergessen", pres: "er vergisst", pret: "er vergaÃŸ", parf: "er hat vergessen", sens: "oublier" },
  { inf: "verstehen", pres: "er versteht", pret: "er verstand", parf: "er hat verstanden", sens: "comprendre" },

  { inf: "waschen", pres: "er wÃ¤scht", pret: "er wusch", parf: "er hat gewaschen", sens: "laver" },
  { inf: "wachsen", pres: "er wÃ¤chst", pret: "er wuchs", parf: "er ist gewachsen", sens: "grandir / pousser" },
  { inf: "waschen", pres: "er wÃ¤scht", pret: "er wusch", parf: "er hat gewaschen", sens: "laver" },
  { inf: "weichen", pres: "er weicht", pret: "er wich", parf: "er ist gewichen", sens: "cÃ©der" },
  { inf: "weisen", pres: "er weist", pret: "er wies", parf: "er hat gewiesen", sens: "indiquer" },

  { inf: "ziehen", pres: "er zieht", pret: "er zog", parf: "er hat gezogen", sens: "tirer" },
  { inf: "zwingen", pres: "er zwingt", pret: "er zwang", parf: "er hat gezwungen", sens: "forcer" },
  { inf: "schmelzen", pres: "er schmilzt", pret: "er schmolz", parf: "er ist geschmolzen", sens: "fondre" },
  { inf: "schlieÃŸen", pres: "er schlieÃŸt", pret: "er schloss", parf: "er hat geschlossen", sens: "fermer" },
  { inf: "lÃ¼gen", pres: "er lÃ¼gt", pret: "er log", parf: "er hat gelogen", sens: "mentir" },

  { inf: "steigen", pres: "er steigt", pret: "er stieg", parf: "er ist gestiegen", sens: "monter" },
  { inf: "streiten", pres: "er streitet", pret: "er stritt", parf: "er hat gestritten", sens: "se disputer" },
  { inf: "treiben", pres: "er treibt", pret: "er trieb", parf: "er hat getrieben", sens: "pousser / pratiquer" },
  { inf: "tun", pres: "er tut", pret: "er tat", parf: "er hat getan", sens: "faire" },
  { inf: "verzeihen", pres: "er verzeiht", pret: "er verzieh", parf: "er hat verziehen", sens: "pardonner" },

  { inf: "winden", pres: "er windet", pret: "er wand", parf: "er hat gewunden", sens: "tordre" },
  { inf: "werfen", pres: "er wirft", pret: "er warf", parf: "er hat geworfen", sens: "jeter" },
  { inf: "ziehen", pres: "er zieht", pret: "er zog", parf: "er ist gezogen", sens: "dÃ©mÃ©nager" },
  { inf: "sinken", pres: "er sinkt", pret: "er sank", parf: "er ist gesunken", sens: "couler" },
  { inf: "stinken", pres: "er stinkt", pret: "er stank", parf: "er hat gestunken", sens: "puer" },

  { inf: "schelten", pres: "er schilt", pret: "er schalt", parf: "er hat gescholten", sens: "gronder" },
  { inf: "scheren", pres: "er schert", pret: "er schor", parf: "er hat geschoren", sens: "tondre" },
  { inf: "schieben", pres: "er schiebt", pret: "er schob", parf: "er hat geschoben", sens: "pousser" },
  { inf: "schwÃ¶ren", pres: "er schwÃ¶rt", pret: "er schwor", parf: "er hat geschworen", sens: "jurer" },
  { inf: "sieden", pres: "er siedet", pret: "er sott", parf: "er hat gesotten", sens: "bouillir" },

  { inf: "verderben", pres: "er verdirbt", pret: "er verdarb", parf: "er ist verdorben", sens: "gÃ¢cher" },
  { inf: "wiegen", pres: "er wiegt", pret: "er wog", parf: "er hat gewogen", sens: "peser" },
  { inf: "zeihen", pres: "er zeiht", pret: "er zieh", parf: "er hat geziehen", sens: "accuser" },
  { inf: "zerschneiden", pres: "er zerschneidet", pret: "er zerschnitt", parf: "er hat zerschnitten", sens: "dÃ©couper" },
  { inf: "ziehen", pres: "er zieht", pret: "er zog", parf: "er hat gezogen", sens: "tirer" },

  { inf: "ab/biegen", pres: "er biegt ab", pret: "er bog ab", parf: "er hat abgebogen", sens: "tourner" },
  { inf: "ab/nehmen", pres: "er nimmt ab", pret: "er nahm ab", parf: "er hat abgenommen", sens: "perdre du poids / enlever" },
  { inf: "an/binden", pres: "er bindet an", pret: "er band an", parf: "er hat angebunden", sens: "attacher" },
  { inf: "auf/brechen", pres: "er bricht auf", pret: "er brach auf", parf: "er ist aufgebrochen", sens: "partir / forcer" },
  { inf: "auf/essen", pres: "er isst auf", pret: "er aÃŸ auf", parf: "er hat aufgegessen", sens: "finir de manger" },
  { inf: "auf/fallen", pres: "er fÃ¤llt auf", pret: "er fiel auf", parf: "er ist aufgefallen", sens: "frapper lâ€™attention" },
  { inf: "auf/geben", pres: "er gibt auf", pret: "er gab auf", parf: "er hat aufgegeben", sens: "abandonner" },
  { inf: "auf/stehen", pres: "er steht auf", pret: "er stand auf", parf: "er ist aufgestanden", sens: "se lever" },
  { inf: "aus/steigen", pres: "er steigt aus", pret: "er stieg aus", parf: "er ist ausgestiegen", sens: "descendre (vÃ©hicule)" },
  { inf: "bei/beiÃŸen", pres: "er beiÃŸt zu", pret: "er biss zu", parf: "er hat zugebissen", sens: "mordre" },

  { inf: "behalten", pres: "er behÃ¤lt", pret: "er behielt", parf: "er hat behalten", sens: "garder" },
  { inf: "bei/bringen", pres: "er bringt bei", pret: "er brachte bei", parf: "er hat beigebracht", sens: "apprendre (enseigner)" },
  { inf: "ein/werfen", pres: "er wirft ein", pret: "er warf ein", parf: "er hat eingeworfen", sens: "jeter dedans" },
  { inf: "ein/ziehen", pres: "er zieht ein", pret: "er zog ein", parf: "er ist eingezogen", sens: "emmÃ©nager" },
  { inf: "empfinden", pres: "er empfindet", pret: "er empfand", parf: "er hat empfunden", sens: "ressentir" },
  { inf: "ent/kommen", pres: "er kommt ent", pret: "er kam ent", parf: "er ist entkommen", sens: "sâ€™Ã©chapper" },
  { inf: "ent/stehen", pres: "er entsteht", pret: "er entstand", parf: "er ist entstanden", sens: "naÃ®tre / surgir" },
  { inf: "erkennen", pres: "er erkennt", pret: "er erkannte", parf: "er hat erkannt", sens: "reconnaÃ®tre" },
  { inf: "erwÃ¤gen", pres: "er erwÃ¤gt", pret: "er erwog", parf: "er hat erwogen", sens: "envisager" },
  { inf: "essen", pres: "er isst", pret: "er aÃŸ", parf: "er hat gegessen", sens: "manger" },

  { inf: "fest/halten", pres: "er hÃ¤lt fest", pret: "er hielt fest", parf: "er hat festgehalten", sens: "retenir" },
  { inf: "fort/fahren", pres: "er fÃ¤hrt fort", pret: "er fuhr fort", parf: "er ist fortgefahren", sens: "continuer / partir" },
  { inf: "fort/gehen", pres: "er geht fort", pret: "er ging fort", parf: "er ist fortgegangen", sens: "sâ€™en aller" },
  { inf: "frei/geben", pres: "er gibt frei", pret: "er gab frei", parf: "er hat freigegeben", sens: "libÃ©rer" },
  { inf: "hin/fallen", pres: "er fÃ¤llt hin", pret: "er fiel hin", parf: "er ist hingefallen", sens: "tomber" },
  { inf: "hin/kommen", pres: "er kommt hin", pret: "er kam hin", parf: "er ist hingekommen", sens: "arriver" },
  { inf: "los/lassen", pres: "er lÃ¤sst los", pret: "er lieÃŸ los", parf: "er hat losgelassen", sens: "lÃ¢cher" },
  { inf: "mit/bringen", pres: "er bringt mit", pret: "er brachte mit", parf: "er hat mitgebracht", sens: "apporter avec soi" },
  { inf: "mit/nehmen", pres: "er nimmt mit", pret: "er nahm mit", parf: "er hat mitgenommen", sens: "emporter" },
  { inf: "nach/denken", pres: "er denkt nach", pret: "er dachte nach", parf: "er hat nachgedacht", sens: "rÃ©flÃ©chir" },

  { inf: "preis/geben", pres: "er gibt preis", pret: "er gab preis", parf: "er hat preisgegeben", sens: "divulguer" },
  { inf: "statt/finden", pres: "er findet statt", pret: "er fand statt", parf: "er hat stattgefunden", sens: "avoir lieu" },
  { inf: "teil/nehmen", pres: "er nimmt teil", pret: "er nahm teil", parf: "er hat teilgenommen", sens: "participer" },
  { inf: "Ã¼ber/geben", pres: "er gibt Ã¼ber", pret: "er gab Ã¼ber", parf: "er hat Ã¼bergeben", sens: "remettre / vomir" },
  { inf: "Ã¼ber/nehmen", pres: "er Ã¼bernimmt", pret: "er Ã¼bernahm", parf: "er hat Ã¼bernommen", sens: "reprendre / assumer" },
  { inf: "um/steigen", pres: "er steigt um", pret: "er stieg um", parf: "er ist umgestiegen", sens: "changer (transport)" },
  { inf: "unter/gehen", pres: "er geht unter", pret: "er ging unter", parf: "er ist untergegangen", sens: "sombrer / se coucher" },
  { inf: "ver/geben", pres: "er vergibt", pret: "er vergab", parf: "er hat vergeben", sens: "pardonner" },
  { inf: "ver/lassen", pres: "er verlÃ¤sst", pret: "er verlieÃŸ", parf: "er hat verlassen", sens: "quitter" },
  { inf: "ver/meiden", pres: "er vermeidet", pret: "er vermied", parf: "er hat vermieden", sens: "Ã©viter" },

  { inf: "vor/lesen", pres: "er liest vor", pret: "er las vor", parf: "er hat vorgelesen", sens: "lire Ã  voix haute" },
  { inf: "weg/werfen", pres: "er wirft weg", pret: "er warf weg", parf: "er hat weggeworfen", sens: "jeter" },
  { inf: "weiter/geben", pres: "er gibt weiter", pret: "er gab weiter", parf: "er hat weitergegeben", sens: "transmettre" },
  { inf: "zu/binden", pres: "er bindet zu", pret: "er band zu", parf: "er hat zugebunden", sens: "attacher" },
  { inf: "zu/geben", pres: "er gibt zu", pret: "er gab zu", parf: "er hat zugegeben", sens: "avouer" },
  { inf: "zu/nehmen", pres: "er nimmt zu", pret: "er nahm zu", parf: "er hat zugenommen", sens: "prendre du poids" },
  { inf: "zurÃ¼ck/kommen", pres: "er kommt zurÃ¼ck", pret: "er kam zurÃ¼ck", parf: "er ist zurÃ¼ckgekommen", sens: "revenir" },
  { inf: "zusammen/kommen", pres: "er kommt zusammen", pret: "er kam zusammen", parf: "er ist zusammengekommen", sens: "se rÃ©unir" },
  { inf: "zunehmen", pres: "er nimmt zu", pret: "er nahm zu", parf: "er hat zugenommen", sens: "augmenter" }
];

function getDictionnaireVerbes() {
  const dict = {};

  // verbes de base
  verbes.forEach(v => {
    dict[v.inf.toLowerCase()] = v;
  });

  // verbes personnalisÃ©s (toutes listes)
  Object.values(listesPerso).forEach(liste => {
    liste.forEach(v => {
      dict[v.inf.toLowerCase()] = v;
    });
  });

  return dict;
}


// ============VERBES PERSONNALISÃ©S =================//

//listesPerso = {
//  "Ma liste 1": [ {inf, pres, ...}, ... ],
//  "Verbes difficiles": [ ... ],
//  "Cours allemand": [ ... ]
//}

function supprimerListe(nom) {
  if (!confirm(`Supprimer la liste "${nom}" ?`)) return;
  delete listesPerso[nom];
  localStorage.setItem("listesPerso", JSON.stringify(listesPerso));
  afficherListes();
}


let listesPerso =
  JSON.parse(localStorage.getItem("listesPerso")) || {};

let listePersoActive = null;

    let verbesPersonnalises =
        JSON.parse(localStorage.getItem("verbesPerso")) || [];

  let verbesDeBase = [...verbes];
  let verbesActifs = verbesDeBase;


function creerListe() {
  const nom = nomListe.value.trim();
  if (!nom || listesPerso[nom]) {
    alert("Nom invalide ou dÃ©jÃ  existant");
    return;
  }

  listesPerso[nom] = [];
  localStorage.setItem("listesPerso", JSON.stringify(listesPerso));
  nomListe.value = "";
  afficherListes();
}

function afficherListes() {
  const div = document.getElementById("listesExistantes");
  div.innerHTML = "<h3>ğŸ“š Listes existantes</h3>";

  Object.keys(listesPerso).forEach(nom => {
    const container = document.createElement("div");

    const span = document.createElement("span");
    span.textContent = nom;

    const btnEdit = document.createElement("button");
    btnEdit.textContent = "âœï¸";
    btnEdit.addEventListener("click", () => ouvrirListe(nom));

    const btnDelete = document.createElement("button");
    btnDelete.textContent = "âŒ";
    btnDelete.addEventListener("click", () => supprimerListe(nom));

    container.appendChild(span);
    container.appendChild(btnEdit);
    container.appendChild(btnDelete);

    div.appendChild(container);
  });
}

// autocompletion verbe personnalisÃ© lors de la saisie
function autoCompleterVerbe() {
  const inf = p_inf.value.trim().toLowerCase();
  if (!inf) return;

  const dict = getDictionnaireVerbes();
  const verbe = dict[inf];

  if (verbe) {
    p_pres.value = verbe.pres || "";
    p_pret.value = verbe.pret || "";
    p_parf.value = verbe.parf || "";
    p_sens.value = verbe.sens || "";

    p_pres.disabled = true;
    p_pret.disabled = true;
    p_parf.disabled = true;
    p_sens.disabled = true;
  } else {
    p_pres.disabled = false;
    p_pret.disabled = false;
    p_parf.disabled = false;
    p_sens.disabled = false;
  }
}


// =========== VERBES DÃ‰BLOQUÃ‰S ==============
function getVerbesDebloques(listeVerbes) {
  const TAILLE_GROUPE = 5;
  let groupesDebloques = 1; // le 1er est toujours dispo

  for (let i = 0; i < listeVerbes.length; i += TAILLE_GROUPE) {
    const groupe = listeVerbes.slice(i, i + TAILLE_GROUPE);

    const maitrisÃ©s = groupe.filter(v =>
      stats[v.inf] && stats[v.inf].maitrise >= 3 // les verbes suivants sont dÃ©bloquÃ©s quand tous les premiers verbes sont maÃ®trisÃ©s
    ).length;

    if (maitrisÃ©s >= 3) {
      groupesDebloques++;
      console.log("Groupes dÃ©bloquÃ©s");
    } else {
      break;
    }
  }

  return listeVerbes.slice(0, groupesDebloques * TAILLE_GROUPE);
}



// ================== NORMALISATION ==================
function normaliser(texte) {
  return texte.trim().toLowerCase();
}

// ================ ANIMATION QUAND ON RÃ‰USSI UN VERBE ==============

function animationBonneReponse() {
  const card = document.querySelector(".card");
  card.classList.remove("success-animation"); // reset
  void card.offsetWidth; // force reflow
  card.classList.add("success-animation");
}


// ================== SUCCÃˆS ====================
const SUCCES = [
  {
    id: "premier_verbe",
    titre: "PremiÃ¨re victoire ğŸ‰",
    description: "RÃ©viser ton premier verbe",
    condition: () => {
      return Object.values(stats).some(s => s.propositions >= 1);
    }
  },
  {
    id: "10_maitrises",
    titre: "Ã‡a rentre ! ğŸ’ª",
    description: "Atteindre 10 maÃ®trises",
    condition: () => {
      return Object.values(stats).reduce((s, v) => s + v.maitrise, 0) >= 10;
    }
  },
  {
    id: "streak_7",
    titre: "RÃ©gularitÃ© ğŸ”¥",
    description: "SÃ©rie de 7 jours consÃ©cutifs",
    condition: () => {
      const streak = JSON.parse(localStorage.getItem("streak")) || { count: 0 };
      return streak.count >= 7;
    }
  },
  {
    id: "sans_faute",
    titre: "Sans faute ğŸ§ ",
    description: "3 rÃ©ponses parfaites dâ€™affilÃ©e",
    condition: () => {
      return succesState.perfectStreak >= 3;
    }
  },
  {
  id: "verbe_maitrise",
  titre: "Sous contrÃ´le âœ…",
  description: "MaÃ®triser complÃ¨tement un verbe",
  condition: () => {
    return Object.values(stats).some(v => v.maitrise >= 5);
    }
  },
  {
  id: "revanche",
  titre: "Revanche ğŸ”",
  description: "Transformer un verbe problÃ©matique en verbe maÃ®trisÃ©",
  condition: () => {
      return Object.values(stats).some(v => v.erreurs >= 3 && v.maitrise >= 5);
    }
  },
{
  id: "50_propositions",
  titre: "Ã‡a travaille ğŸ“š",
  description: "RÃ©viser 50 verbes au total",
  condition: () => {
    return Object.values(stats)
      .reduce((s, v) => s + v.propositions, 0) >= 50;
  }
},
{
  id: "100_propositions",
  titre: "Machine Ã  verbes ğŸ¤–",
  description: "RÃ©viser 100 verbes au total",
  condition: () => {
    return Object.values(stats)
      .reduce((s, v) => s + v.propositions, 0) >= 100;
  }
},
{
  id: "verbes_problematiques",
  titre: "Face Ã  la difficultÃ© ğŸ§±",
  description: "RÃ©viser 10 fois des verbes problÃ©matiques",
  condition: () => {
    return sessionStats.problematiquesRevises >= 10;
  }
},
{
  id: "tout_vert",
  titre: "Tout au vert âœ…",
  description: "Avoir 5 verbes en zone maÃ®trisÃ©e",
  condition: () => {
    return Object.values(stats)
      .filter(v => v.maitrise >= 5 && v.erreurs === 0).length >= 5;
  }
},
{
  id: "createur_verbes",
  titre: "CrÃ©ateur ğŸ“–",
  description: "CrÃ©er 10 verbes personnalisÃ©s",
  condition: () => {
    return Object.keys(verbesPersonnalises || {}).length >= 10;
  }
},
{
  id: "exporteur",
  titre: "Sauvegarde ğŸ”",
  description: "Exporter ses statistiques ou ses verbes",
  condition: () => {
    return succesState.exportEffectue === true;
  }
},
{
  id: "importeur",
  titre: "Retour gagnant ğŸ”„",
  description: "Importer des statistiques ou une liste",
  condition: () => {
    return succesState.importEffectue === true;
  }
},
{
  id: "revision_planifiee",
  titre: "MÃ©moire longue ğŸ§ ",
  description: "ComplÃ©ter 5 rÃ©visions planifiÃ©es",
  condition: () => {
    return succesState.revisionsPlanifiees >= 5;
  }
},
{
  id: "streak_30",
  titre: "Habitude ancrÃ©e ğŸ”¥",
  description: "SÃ©rie de 30 jours consÃ©cutifs",
  condition: () => {
    const streak = JSON.parse(localStorage.getItem("streak")) || { count: 0 };
    return streak.count >= 30;
  }
},
{
  id: "perfectionniste",
  titre: "Perfectionniste âœ¨",
  description: "RÃ©pondre parfaitement Ã  10 verbes consÃ©cutifs",
  condition: () => {
    return succesState.perfectStreak >= 10;
  }
}

];

let succesState = JSON.parse(localStorage.getItem("succes")) || {
  debloques: [],
  perfectStreak: 0
};

function verifierSucces() {
  let nouveau = false;

  SUCCES.forEach(s => {
    if (!succesState.debloques.includes(s.id) && s.condition()) {
      succesState.debloques.push(s.id);
      afficherSucces(s);
      nouveau = true;
    }
  });

  if (nouveau) {
    localStorage.setItem("succes", JSON.stringify(succesState));
  }
}

function afficherSucces(succes) {
  const div = document.createElement("div");
  div.style.position = "fixed";
  div.style.bottom = "20px";
  div.style.right = "20px";
  div.style.background = "#ffd700";
  div.style.padding = "15px";
  div.style.borderRadius = "10px";
  div.style.boxShadow = "0 4px 10px rgba(0,0,0,.2)";
  div.style.zIndex = 9999;
  div.innerHTML = `
    <strong>ğŸ† SuccÃ¨s dÃ©bloquÃ© !</strong><br>
    ${succes.titre}<br>
    <small>${succes.description}</small>
  `;

  document.body.appendChild(div);

  setTimeout(() => div.remove(), 4000);
}


// ================== VARIABLES ==================
let mode = "random";
let current = null;
let questionType = "classique";

const youpiAudio = document.getElementById("youpiAudio");
const eOhAudio = document.getElementById("eOhAudio");

let stats = JSON.parse(localStorage.getItem("stats")) || {};
let streak = JSON.parse(localStorage.getItem("streak")) || {
  count: 0,
  lastDate: null
};

verbes.forEach(v => {
  if (!stats[v.inf]) stats[v.inf] = stats[inf] = {
  propositions: 0,
  erreurs: 0,
  maitrise: 0,
  nextReview: null,   // timestamp
  interval: 0         // index dâ€™intervalle
};
;
});

let cacheTousLesVerbes = [];

const TAILLE_GROUPE = 5;

function getGroupIndex(index) {
  return Math.floor(index / TAILLE_GROUPE);
}

function groupesDebloques() {
  let groupes = [];

  for (let i = 0; i < verbes.length; i += TAILLE_GROUPE) {
    const groupe = verbes.slice(i, i + TAILLE_GROUPE);

    const maitriseOK = groupe.every(v => stats[v.inf]?.maitrise >= 1);

    groupes.push({
      debut: i + 1,
      fin: Math.min(i + TAILLE_GROUPE, verbes.length),
      debloque: maitriseOK
    });

    if (!maitriseOK) break;
  }

  return groupes;
}

// =================Notifications ========

function verifierRevisions() {
  if (localStorage.getItem("notificationsActivees") !== "true") return;

  const today = new Date().toISOString().slice(0,10);
  const derniereNotif = localStorage.getItem("derniereNotification");

  if (derniereNotif === today) return;

  const aReviser = verbesEnAttenteDeRevision();

  if (aReviser.length > 0) {
    envoyerNotification(aReviser.length);
    localStorage.setItem("derniereNotification", today);
  }
}

function activerNotifications() {
  if (!("Notification" in window)) {
    alert("Les notifications ne sont pas supportÃ©es par ce navigateur.");
    return;
  }

  Notification.requestPermission().then(permission => {
    if (permission === "granted") {
      localStorage.setItem("notificationsActivees", "true");
      alert("ğŸ”” Notifications activÃ©es !");
      verifierRevisions(); // test immÃ©diat
    } else {
      alert("Notifications refusÃ©es.");
    }
  });
}

function verbesEnAttenteDeRevision() {
  const maintenant = Date.now();
  return verbes.filter(v => stats[v.inf]?.nextReview <= maintenant);
}



function envoyerNotification(nb) {
  if (Notification.permission !== "granted") return;

  new Notification("ğŸ“˜ RÃ©vision allemande", {
    body: `Tu as ${nb} verbe(s) Ã  rÃ©viser aujourdâ€™hui ğŸ’ª`,
  });
}

verifierRevisions();
setInterval(verifierRevisions, 60 * 60 * 1000); // toutes les heures


function desactiverNotifications() {
  localStorage.setItem("notificationsActivees", "false");
  localStorage.removeItem("derniereNotification");

  alert("ğŸ”• Notifications dÃ©sactivÃ©es");

  document.getElementById("btnActiverNotif").classList.remove("hidden");
  document.getElementById("btnDesactiverNotif").classList.add("hidden");
}

function majBoutonsNotifications() {
  const actives = localStorage.getItem("notificationsActivees") === "true";

  document.getElementById("btnActiverNotif").classList.toggle("hidden", actives);
  document.getElementById("btnDesactiverNotif").classList.toggle("hidden", !actives);
}

majBoutonsNotifications();

document.getElementById("etatNotif").textContent =
  localStorage.getItem("notificationsActivees") === "true"
  ? "ğŸ”” ActivÃ©es"
  : "ğŸ”• DÃ©sactivÃ©es";


// ================== PALIERS ==================
function getNombrePaliersDebloques() {
  let paliers = 1;
  while (true) {
    const debut = (paliers - 1) * TAILLE_PALIER;
    const groupe = verbes.slice(debut, debut + TAILLE_PALIER);
    if (groupe.length < TAILLE_PALIER) break;
    if (groupe.every(v => stats[v.inf].maitrise >= SEUIL_MAITRISE)) paliers++;
    else break;
  }
  return paliers;
}

function verbesDisponibles() {
  const groupes = groupesDebloques();
  let maxIndex = groupes.length * TAILLE_GROUPE;

  // RÃ©activation de verbes anciens (spaced repetition)
  let anciens = verbesActifs.slice(0, maxIndex - TAILLE_GROUPE);
  let nouveaux = verbesActifs.slice(0, maxIndex);

  return Math.random() < 0.3 && anciens.length ? anciens : nouveaux;
}

function choisirVerbe() {
  const verbesDisponibles = getVerbesDebloques(verbesActifs);

  // rÃ©activation d'anciens verbes (oubli contrÃ´lÃ©)
  const anciens = verbesDisponibles.filter(v =>
    stats[v.inf].erreurs > stats[v.inf].maitrise
  );

  let pool = verbesDisponibles;

  // 30 % de chance de revoir un ancien verbe
  if (anciens.length > 0 && Math.random() < 0.3) {
    pool = anciens;
  }

  return pool[Math.floor(Math.random() * pool.length)];
}

function afficherStats() {
  document.getElementById("menu").classList.add("hidden");
  document.getElementById("quiz").classList.add("hidden");
  document.getElementById("statsPanel").classList.remove("hidden");

  let total = 0, erreurs = 0, maitrise = 0;

  Object.values(stats).forEach(s => {
    total += s.propositions;
    erreurs += s.erreurs;
    maitrise += s.maitrise;
  });

  const groupes = groupesDebloques();

  let html = `
    <p>ğŸ“˜ RÃ©ponses totales : <strong>${total}</strong></p>
    <p>âŒ Erreurs : <strong>${erreurs}</strong></p>
    <p>â­ MaÃ®trises : <strong>${maitrise}</strong></p>
    <hr>
    <h3>ğŸ“¦ Groupes dÃ©bloquÃ©s</h3>
  `;

  groupes.forEach((g, i) => {
    html += `
      <p>
        Groupe ${i + 1} (verbes ${g.debut}â€“${g.fin}) :
        ${g.debloque ? "âœ… DÃ©bloquÃ©" : "ğŸ”’ VerrouillÃ©"}
      </p>
    `;
  });

  document.getElementById("statsContent").innerHTML = html;
  const streak = JSON.parse(localStorage.getItem("streak")) || { count: 0 };

html += `
  <hr>
  <h3>ğŸ”¥ SÃ©rie de jours</h3>
  <p>
    SÃ©rie actuelle :
    <strong style="font-size:18px;">
      ${streak.count} jour${streak.count > 1 ? "s" : ""}
    </strong>
  </p>
`;

html += `
  <hr>
  <h3>ğŸ† SuccÃ¨s</h3>
`;

SUCCES.forEach(s => {
  const debloque = succesState.debloques.includes(s.id);
  html += `
    <div style="
      padding:8px;
      margin-bottom:6px;
      border-radius:6px;
      background:${debloque ? "#d4edda" : "#eee"};
      opacity:${debloque ? "1" : "0.5"};
    ">
      <strong>${debloque ? "âœ…" : "ğŸ”’"} ${s.titre}</strong><br>
      <small>${s.description}</small>
    </div>
  `;
});

  document.getElementById("statsContent").innerHTML = html;

}

function fermerStats() {
  document.getElementById("statsPanel").classList.add("hidden");
  document.getElementById("menu").classList.remove("hidden");
}


// =========== STREAK JOURNALIER ==================
function majStreak() {
  const today = new Date().toISOString().slice(0, 10);

  if (streak.lastDate === today) return; // dÃ©jÃ  comptÃ© aujourdâ€™hui

  if (!streak.lastDate) {
    streak.count = 1;
  } else {
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const yestStr = yesterday.toISOString().slice(0, 10);

    if (streak.lastDate === yestStr) {
      streak.count++;
    } else {
      streak.count = 1; // streak cassÃ©e
    }
  }

  streak.lastDate = today;
  localStorage.setItem("streak", JSON.stringify(streak));
}


// ================== QUIZ ==================
function start(m) {
  mode = m;
  menu.classList.add("hidden");
  quiz.classList.remove("hidden");
  next();
}

function next() {
  current = choisirVerbe();
  stats[current.inf].propositions++;

  questionType = QUESTION_TYPES[Math.floor(Math.random()*QUESTION_TYPES.length)];

  inf.textContent = "";
  sens.textContent = "";
  extraInput.value = "";
  pres.value = pret.value = parf.value = "";

  extraLabel.classList.add("hidden");
  presLabel.classList.remove("hidden");
  pretLabel.classList.remove("hidden");
  parfLabel.classList.remove("hidden");

  if (questionType === "classique") {
    inf.textContent = current.inf;
    sens.textContent = current.sens;
  }

  if (questionType === "sens_inf") {
    sens.textContent = current.sens;
    extraLabel.classList.remove("hidden");
    presLabel.classList.add("hidden");
    pretLabel.classList.add("hidden");
    parfLabel.classList.add("hidden");
  }

  if (questionType === "inf_sens") {
    inf.textContent = current.inf;
    extraLabel.classList.remove("hidden");
    presLabel.classList.add("hidden");
    pretLabel.classList.add("hidden");
    parfLabel.classList.add("hidden");
  }

  result.innerHTML = "";
  nextBtn.classList.add("hidden");
  messageEncouragement.classList.add("hidden");
}

function normaliserAvancee(texte) {
  return texte
    .trim()
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "");
}

function reponseCorrecte(userInput, solutions) {
  const user = normaliserAvancee(userInput);
  return solutions
    .split(/[,/]/)
    .map(s => normaliserAvancee(s))
    .some(s => s === user);
}

function comparaisonVisuelle(userInput, solution) { //affiche quels sont les erreurs caractÃ¨res par caractÃ¨res
  let html = "";
  const max = Math.max(userInput.length, solution.length);

  for (let i = 0; i < max; i++) {
    const u = userInput[i] || "";
    const s = solution[i] || "";

    if (u === s) {
      html += `<span style="color:green">${u}</span>`;
    } else {
      html += `<span style="color:red">${u || "â£"}</span>`;
    }
  }
  return html;
}



function check() {
  let score = 0;
  let feedback = "";

  if (questionType === "classique") {

    if (normaliserAvancee(pres.value) === normaliserAvancee(current.pres)) {
      score++;
    } else {
      feedback += `<br>PrÃ©sent : ${comparaisonVisuelle(pres.value, current.pres)}`;
    }

    if (normaliserAvancee(pret.value) === normaliserAvancee(current.pret)) {
      score++;
    } else {
      feedback += `<br>PrÃ©tÃ©rit : ${comparaisonVisuelle(pret.value, current.pret)}`;
    }

    if (normaliserAvancee(parf.value) === normaliserAvancee(current.parf)) {
      score++;
    } else {
      feedback += `<br>Parfait : ${comparaisonVisuelle(parf.value, current.parf)}`;
    }
  }

  if (questionType === "sens_inf") {
    if (reponseCorrecte(extraInput.value, current.inf)) score = 3;
    else feedback = comparaisonVisuelle(extraInput.value, current.inf);
  }

  if (questionType === "inf_sens") {
    if (reponseCorrecte(extraInput.value, current.sens)) score = 3;
    else feedback = comparaisonVisuelle(extraInput.value, current.sens.split(/[,/]/)[0]);
  }

if (score === 3) {
  stats[current.inf].maitrise++;
  youpiAudio.play();
  animationBonneReponse();
}
 else {
    stats[current.inf].erreurs++;
    eOhAudio.play();
  }

  localStorage.setItem("stats", JSON.stringify(stats));

  result.innerHTML = `
    <strong>Correction :</strong><br>
    Infinitif : ${current.inf}<br>
    Sens : ${current.sens}<br>
    PrÃ©sent : ${current.pres}<br>
    PrÃ©tÃ©rit : ${current.pret}<br>
    Parfait : ${current.parf}<br>
    ğŸ¯ Score : ${score}/3
    ${feedback ? "<hr>ğŸ›  DÃ©tails :<br>" + feedback : ""}
  `;

  if (score === 3) nextBtn.classList.remove("hidden");
  else messageEncouragement.classList.remove("hidden");
  majStreak();
  if (score === 3) {
  succesState.perfectStreak++;
} else {
  succesState.perfectStreak = 0;
}

verifierSucces();
localStorage.setItem("succes", JSON.stringify(succesState));

}


// IMPORTER EXPORTER STATISTIQUE



function exporterDonnees() {
  const data = {
    stats: JSON.parse(localStorage.getItem("stats")) || {},
    progression: JSON.parse(localStorage.getItem("progression")) || {},
    streak: JSON.parse(localStorage.getItem("streak")) || {},
    notificationsActivees: localStorage.getItem("notificationsActivees"),
    derniereNotification: localStorage.getItem("derniereNotification"),
    dateExport: new Date().toISOString()
  };

  const blob = new Blob([JSON.stringify(data, null, 2)], {
    type: "application/json"
  });

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "verbes_allemands_stats.json";
  a.click();
  URL.revokeObjectURL(url);
}

function importerDonnees() {
  document.getElementById("importFile").click();
}

document.getElementById("importFile").addEventListener("change", function () {
  const file = this.files[0];
  if (!file) return;

  const reader = new FileReader();

  reader.onload = function (e) {
    try {
      const data = JSON.parse(e.target.result);

      if (!data.stats) throw "Fichier invalide";

      localStorage.setItem("stats", JSON.stringify(data.stats));
      localStorage.setItem("progression", JSON.stringify(data.progression || {}));
      localStorage.setItem("streak", JSON.stringify(data.streak || {count:0}));
      localStorage.setItem("notificationsActivees", data.notificationsActivees || "false");

      if (data.derniereNotification) {
        localStorage.setItem("derniereNotification", data.derniereNotification);
      }

      alert("âœ… Statistiques importÃ©es avec succÃ¨s !");
      location.reload();

    } catch (err) {
      alert("âŒ Fichier invalide ou corrompu");
    }
  };

  reader.readAsText(file);
});




//======= PDF EXPORTER ======


function exporterPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const stats = JSON.parse(localStorage.getItem("stats")) || {};
  const streak = JSON.parse(localStorage.getItem("streak")) || { count: 0 };

  let y = 15;

  // ğŸ“˜ Titre
  doc.setFontSize(18);
  doc.text("RÃ©vision des verbes allemands", 10, y);
  y += 10;

  doc.setFontSize(10);
  doc.text(`ExportÃ© le : ${new Date().toLocaleDateString()}`, 10, y);
  y += 10;

  // ğŸ”¥ Streak
  doc.setFontSize(12);
  doc.text(`Streak actuel : ${streak.count || 0} jour(s)`, 10, y);
  y += 10;

  // ğŸ“Š Stats globales
  let total = 0, mait = 0, erreurs = 0;

  Object.values(stats).forEach(v => {
    total += v.propositions || 0;
    mait += v.maitrise || 0;
    erreurs += v.erreurs || 0;
  });

  doc.text(`Statistiques globales`, 10, y);
  y += 6;
  doc.text(`â€¢ Tentatives : ${total}`, 12, y); y += 5;
  doc.text(`â€¢ MaÃ®trises : ${mait}`, 12, y); y += 5;
  doc.text(`â€¢ Erreurs : ${erreurs}`, 12, y); y += 10;

  // ğŸ”“ Groupes dÃ©bloquÃ©s
  const groupesDebloques = Math.floor(
    Object.values(stats).filter(v => v.maitrise >= 3).length / 5
  );

  doc.text(`Groupes dÃ©bloquÃ©s : ${groupesDebloques}`, 10, y);
  y += 10;

  // ğŸ§  Verbes maÃ®trisÃ©s
  doc.text("Verbes maÃ®trisÃ©s :", 10, y);
  y += 6;

  Object.entries(stats)
    .filter(([_, v]) => v.maitrise >= 3)
    .slice(0, 15)
    .forEach(([inf]) => {
      doc.text(`â€¢ ${inf}`, 12, y);
      y += 5;
    });

  y += 5;

  // âš ï¸ Verbes Ã  revoir
  doc.text("Verbes Ã  revoir :", 10, y);
  y += 6;

  Object.entries(stats)
    .filter(([_, v]) => v.erreurs > v.maitrise)
    .slice(0, 10)
    .forEach(([inf]) => {
      doc.text(`â€¢ ${inf}`, 12, y);
      y += 5;
    });

  // ğŸ“„ TÃ©lÃ©chargement
  doc.save("verbes_allemands_progression.pdf");
}

// =========  OUVRIR VERBES PERSO ===========

function ouvrirVerbesPerso() {
  document.getElementById("menu").classList.add("hidden");
  document.getElementById("quiz").classList.add("hidden");
  document.getElementById("verbesPerso").classList.remove("hidden");
  afficherListes();
//  afficherVerbesPerso();
}

function afficherVerbesListe() {
  const div = document.getElementById("listeVerbesPerso");
  const liste = listesPerso[listePersoActive];

  div.innerHTML = "<h4>ğŸ“– Verbes</h4>";

  liste.forEach((v, i) => {
    div.innerHTML += `
      <div>
        ${v.inf} â€“ ${v.sens}
        <button onclick="supprimerVerbeListe(${i})">âŒ</button>
      </div>
    `;
  });
}

function supprimerVerbeListe(index) {
  listesPerso[listePersoActive].splice(index, 1);
  localStorage.setItem("listesPerso", JSON.stringify(listesPerso));
  afficherVerbesListe();
}


function ouvrirListe(nom) {
  listePersoActive = nom;
  document.getElementById("gestionListe").classList.remove("hidden");
  document.getElementById("titreListe").textContent = `ğŸ“˜ ${nom}`;
  afficherVerbesListe();
}

function ajouterVerbePerso() {
  if (!listePersoActive) return;

  const v = {
    inf: p_inf.value.trim(),
    pres: p_pres.value.trim(),
    pret: p_pret.value.trim(),
    parf: p_parf.value.trim(),
    sens: p_sens.value.trim()
  };

if (!v.inf) {
  alert("L'infinitif est obligatoire");
  return;
}

if (!v.pres || !v.pret || !v.parf || !v.sens) {
  alert("Verbe inconnu : merci de complÃ©ter toutes les formes");
  return;
}


  listesPerso[listePersoActive].push(v);
  localStorage.setItem("listesPerso", JSON.stringify(listesPerso));

  if (!stats[v.inf]) {
    stats[v.inf] = { propositions: 0, erreurs: 0, maitrise: 0 };
    localStorage.setItem("stats", JSON.stringify(stats));
  }

  ["p_inf","p_pres","p_pret","p_parf","p_sens"].forEach(id => {
    document.getElementById(id).value = "";
  });
[p_pres, p_pret, p_parf, p_sens].forEach(i => i.disabled = false);

  afficherVerbesListe();

}

function reviserListePerso() {
  const liste = listesPerso[listePersoActive];
  if (!liste.length) {
    alert("Liste vide");
    return;
  }

  verbesActifs = liste;
  mode = "random";

  document.getElementById("verbesPerso").classList.add("hidden");
  document.getElementById("quiz").classList.remove("hidden");

  next();
}


function supprimerVerbePerso(index) {
  const inf = verbesPersonnalises[index].inf;
  verbesPersonnalises.splice(index, 1);

  delete stats[inf];

  localStorage.setItem("verbesPerso", JSON.stringify(verbesPersonnalises));
  localStorage.setItem("stats", JSON.stringify(stats));
  afficherVerbesPerso();
}

function reviserVerbesPerso() {
  if (verbesPersonnalises.length === 0) {
    alert("Aucun verbe personnalisÃ©");
    return;
  }

  verbesActifs = verbesPersonnalises;
  mode = "random";

  document.getElementById("verbesPerso").classList.add("hidden");
  document.getElementById("quiz").classList.remove("hidden");

  next();
}

function exporterListe() {
  if (!listePersoActive) return;

  const data = {
    nom: listePersoActive,
    verbes: listesPerso[listePersoActive]
  };

  const blob = new Blob(
    [JSON.stringify(data, null, 2)],
    { type: "application/json" }
  );

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `${listePersoActive.replace(/\s+/g, "_")}.json`;
  a.click();

  URL.revokeObjectURL(url);
}

function importerListe(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);

      if (!data.nom || !Array.isArray(data.verbes)) {
        throw "Format invalide";
      }

      let nom = data.nom;

      // Ã©viter Ã©crasement
      if (listesPerso[nom]) {
        let i = 2;
        while (listesPerso[`${nom} (${i})`]) i++;
        nom = `${nom} (${i})`;
      }

      listesPerso[nom] = data.verbes;

      // init stats si absentes
      data.verbes.forEach(v => {
        if (!stats[v.inf]) {
          stats[v.inf] = { propositions: 0, erreurs: 0, maitrise: 0 };
        }
      });

      localStorage.setItem("listesPerso", JSON.stringify(listesPerso));
      localStorage.setItem("stats", JSON.stringify(stats));

      afficherListes();
      alert(`Liste "${nom}" importÃ©e avec succÃ¨s`);
    } catch (e) {
      alert("âŒ Fichier invalide");
    }
  };

  reader.readAsText(file);
}

// =============== AFFICHER TOUS LES VERBES DANS STATISTIQUE ======================
function afficherTousLesVerbes() {
  const container = document.getElementById("listeCompleteVerbes");
  container.classList.remove("hidden");

  // fusion verbes de base + verbes personnalisÃ©s
  let tousLesVerbes = [...verbes];
  cacheTousLesVerbes = tousLesVerbes;

  Object.values(listesPerso).forEach(liste => {
    liste.forEach(v => {
      if (!tousLesVerbes.find(x => x.inf === v.inf)) {
        tousLesVerbes.push(v);
      }
    });
  });

let html = `
  <hr>
  <h3>ğŸ“‹ Tous les verbes</h3>

  <div style="margin-bottom:10px;">
    <button onclick="filtrerVerbes('tous')">ğŸ“‹ Tous</button>
    <button onclick="filtrerVerbes('probleme')">ğŸ”´ ProblÃ©matiques</button>
    <button onclick="filtrerVerbes('maitrise')">ğŸŸ¢ MaÃ®trisÃ©s</button>
    <button onclick="filtrerVerbes('encours')">âšª En cours</button>
    <button onclick="reviserVerbesProblemes()">ğŸ¯ RÃ©viser les verbes problÃ©matiques</button>
  </div>

  <table style="width:100%; border-collapse:collapse;">
    <thead>
      <tr style="background:#eee;">
        <th>Infinitif</th>
        <th>Sens</th>
        <th>â­ MaÃ®trise</th>
        <th>âŒ Erreurs</th>
        <th>ğŸ” ProposÃ©</th>
      </tr>
    </thead>
    <tbody id="tbodyVerbes">
`;


  tousLesVerbes.forEach(v => {
    const s = stats[v.inf] || { propositions: 0, erreurs: 0, maitrise: 0 };

    let classe = "verbe-neutre";

    if (s.erreurs > s.maitrise) {
      classe = "verbe-probleme";
    } else if (s.maitrise >= 3 && s.erreurs <= s.maitrise) {
      classe = "verbe-maitrise";
    }

    html += `
      <tr class="${classe}">
        <td>${v.inf}</td>
        <td>${v.sens}</td>
        <td style="text-align:center;">${s.maitrise}</td>
        <td style="text-align:center;">${s.erreurs}</td>
        <td style="text-align:center;">${s.propositions}</td>
      </tr>
    `;
  });


  html += `</table>
    <button onclick="fermerListeComplete()">â¬† Masquer</button>
  `;

  container.innerHTML = html;
}

function fermerListeComplete() {
  document.getElementById("listeCompleteVerbes").classList.add("hidden");
}

// filtrer les verbes

function filtrerVerbes(type) {
  const rows = document.querySelectorAll("#tbodyVerbes tr");

  rows.forEach(row => {
    row.style.display = "";

    if (type === "probleme" && !row.classList.contains("verbe-probleme")) {
      row.style.display = "none";
    }

    if (type === "maitrise" && !row.classList.contains("verbe-maitrise")) {
      row.style.display = "none";
    }

    if (type === "encours" &&
        (row.classList.contains("verbe-probleme") || row.classList.contains("verbe-maitrise"))) {
      row.style.display = "none";
    }
  });
}

// rÃ©viser les verbes problÃ©matiques
function reviserVerbesProblemes() {
  let problematiques = [];

  // verbes de base
  verbes.forEach(v => {
    const s = stats[v.inf];
    if (s && s.erreurs > s.maitrise) {
      problematiques.push(v);
    }
  });

  // verbes personnalisÃ©s
  Object.values(listesPerso).forEach(liste => {
    liste.forEach(v => {
      const s = stats[v.inf];
      if (s && s.erreurs > s.maitrise && !problematiques.find(x => x.inf === v.inf)) {
        problematiques.push(v);
      }
    });
  });

  if (problematiques.length === 0) {
    alert("ğŸ‰ Aucun verbe problÃ©matique !");
    return;
  }

  verbesActifs = problematiques;
  mode = "random";

  document.getElementById("statsPanel").classList.add("hidden");
  document.getElementById("quiz").classList.remove("hidden");

  next();
}




// update streak
document.getElementById("streakMenu").textContent =
  (JSON.parse(localStorage.getItem("streak")) || { count: 0 }).count;

</script>

</body>
</html>

